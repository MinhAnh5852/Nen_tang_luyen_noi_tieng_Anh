<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒêƒÉng k√Ω - AESP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="Learner/styles.css" />
    <style>
      .auth-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; padding: 40px 0; margin-top: 80px; }
      .role-option.selected { border: 2px solid var(--primary-color); background: #f0f7ff; }
      .error-message { color: #e74c3c; font-size: 14px; margin-top: 10px; display: none; padding: 10px; background: #fdf2f2; border-radius: 5px; border: 1px solid #facccc; text-align: center; }
      .btn-loading { pointer-events: none; opacity: 0.7; }
    </style>
  </head>
  <body>
    <header>
      <div class="container header-container">
        <a href="index.html" class="logo">
          <i class="fas fa-robot logo-icon"></i>
          <span class="logo-text">AESP</span>
        </a>
        <div class="auth-buttons">
          <a href="index.html" class="btn btn-outline">Tr·ªü v·ªÅ trang ch·ªß</a>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="auth-container">
        <div class="auth-card">
          <div class="auth-header">
            <h2>ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
            <p>T·∫°o t√†i kho·∫£n ƒë·ªÉ b·∫Øt ƒë·∫ßu luy·ªán n√≥i ti·∫øng Anh v·ªõi AI</p>
          </div>

          <form class="auth-form" id="register-form">
            <div class="role-selection" style="display: flex; gap: 10px; margin-bottom: 20px">
              <div class="role-option" data-role="learner" onclick="selectRole('learner')" style="cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; text-align: center;">
                <i class="fas fa-user-graduate"></i>
                <h4>H·ªçc vi√™n</h4>
              </div>
              <div class="role-option" data-role="mentor" onclick="selectRole('mentor')" style="cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; text-align: center;">
                <i class="fas fa-chalkboard-teacher"></i>
                <h4>Mentor</h4>
              </div>
            </div>

            <input type="hidden" id="user-role" name="role" value="learner" />

            <div class="form-group">
              <label for="register-name">H·ªç v√† t√™n</label>
              <input type="text" id="register-name" placeholder="Nh·∫≠p h·ªç v√† t√™n" required />
            </div>

            <div class="form-group">
              <label for="register-email">Email</label>
              <input type="email" id="register-email" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ email" required />
            </div>

            <div class="form-group">
              <label for="register-password">M·∫≠t kh·∫©u</label>
              <input type="password" id="register-password" placeholder="T·ªëi thi·ªÉu 8 k√Ω t·ª±" required />
            </div>

            <div id="register-error" class="error-message"></div>

            <button type="submit" id="submit-btn" class="btn btn-primary" style="width: 100%; padding: 15px; margin-top: 10px;">
              ƒêƒÉng k√Ω t√†i kho·∫£n
            </button>

            <div class="form-footer">
              <p>ƒê√£ c√≥ t√†i kho·∫£n? <a href="login.html">ƒêƒÉng nh·∫≠p ngay</a></p>
            </div>
          </form>
        </div>
      </div>
      <div id="footer"></div>
    </main>

    <script type="module">
      // 1. IMPORT FIREBASE
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // 2. C·∫§U H√åNH FIREBASE (C·ªßa b·∫°n)
      const firebaseConfig = {
          apiKey: "AIzaSyAR_mMEOLmcQeewl7ECynfLe-0ymFiqx9g",
          authDomain: "pj-luyen-noi-tieng-anh.firebaseapp.com",
          projectId: "pj-luyen-noi-tieng-anh",
          storageBucket: "pj-luyen-noi-tieng-anh.firebasestorage.app",
          messagingSenderId: "835156032196",
          appId: "1:835156032196:web:b8920adabf15ace0bbe791"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      
      // API c·ªßa Python
      const API_MENTOR_SERVICE = 'http://127.0.0.1:5002/api/mentors';

      // H√†m ch·ªçn Role (G·∫Øn v√†o window ƒë·ªÉ g·ªçi ƒë∆∞·ª£c t·ª´ HTML)
      window.selectRole = function(role) {
          document.querySelectorAll(".role-option").forEach((opt) => opt.classList.remove("selected"));
          const selected = document.querySelector(`.role-option[data-role="${role}"]`);
          if(selected) selected.classList.add("selected");
          document.getElementById("user-role").value = role;
      }

      // X·ª≠ l√Ω khi b·∫•m ƒêƒÉng k√Ω
      document.getElementById("register-form").onsubmit = async (e) => {
          e.preventDefault();
          const btn = document.getElementById('submit-btn');
          const errorDiv = document.getElementById('register-error');
          
          const name = document.getElementById('register-name').value.trim();
          const email = document.getElementById('register-email').value.trim();
          const password = document.getElementById('register-password').value;
          const role = document.getElementById("user-role").value.toUpperCase(); // LEARNER ho·∫∑c MENTOR

          errorDiv.style.display = "none";
          btn.innerText = "ƒêang x·ª≠ l√Ω Firebase...";
          btn.classList.add('btn-loading');

          try {
              // --- B∆Ø·ªöC 1: T·∫†O USER TR√äN FIREBASE (ƒê·ªÉ th·∫ßy ch·∫•m) ---
              const userCredential = await createUserWithEmailAndPassword(auth, email, password);
              const firebaseUser = userCredential.user;
              console.log("Firebase OK, UID:", firebaseUser.uid);

              // --- B∆Ø·ªöC 2: G·ªåI PYTHON API ƒê·ªÇ L∆ØU V√ÄO MYSQL (ƒê·ªÉ web ch·∫°y) ---
              if (role === 'MENTOR') {
                  btn.innerText = "ƒêang ƒë·ªìng b·ªô MySQL...";
                  
                  const resMentor = await fetch(API_MENTOR_SERVICE, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          user_id: firebaseUser.uid, // D√πng lu√¥n ID c·ªßa Firebase l√†m ID trong Database
                          full_name: name,
                          bio: "Mentor m·ªõi t·ª´ Firebase",
                          skills: ["General"]
                      })
                  });
                  
                  if (!resMentor.ok) {
                       console.warn("L∆∞u MySQL th·∫•t b·∫°i nh∆∞ng Firebase ƒë√£ t·∫°o xong.");
                  }
              }

              // --- B∆Ø·ªöC 3: L∆ØU TH√îNG TIN V√Ä CHUY·ªÇN TRANG ---
              alert("üéâ ƒêƒÉng k√Ω th√†nh c√¥ng!");
              
              localStorage.setItem('user_token', firebaseUser.accessToken);
              localStorage.setItem('user_uid', firebaseUser.uid);
              localStorage.setItem('user_role', role);

              if (role === 'MENTOR') {
                  window.location.href = './mentor/mentor.html';
              } else {
                  window.location.href = './Learner/index.html';
              }

          } catch (error) {
              console.error(error);
              // X·ª≠ l√Ω th√¥ng b√°o l·ªói ƒë·∫πp h∆°n
              let msg = error.message;
              if (msg.includes("email-already-in-use")) msg = "Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!";
              else if (msg.includes("weak-password")) msg = "M·∫≠t kh·∫©u qu√° y·∫øu!";
              
              errorDiv.innerText = "‚ùå " + msg;
              errorDiv.style.display = "block";
              btn.innerText = "ƒêƒÉng k√Ω t√†i kho·∫£n";
              btn.classList.remove('btn-loading');
          }
      };

      // M·∫∑c ƒë·ªãnh load footer
      document.addEventListener("DOMContentLoaded", () => {
          window.selectRole("mentor");
          fetch("Learner/footer.html").then(r => r.text()).then(d => {
             document.getElementById("footer").innerHTML = d;
          }).catch(() => {});
      });
    </script>
  </body>
</html>