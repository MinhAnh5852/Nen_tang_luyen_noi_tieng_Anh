<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập - AESP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 40px 0;
            margin-top: 80px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <a href="index.html" class="logo">
                <i class="fas fa-robot logo-icon"></i>
                <span class="logo-text">AESP</span>
            </a>
            
            <div class="auth-buttons">
                <a href="index.html" class="btn btn-outline">Trở về trang chủ</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h2>Đăng nhập</h2>
                    <p>Chào mừng trở lại! Vui lòng đăng nhập để tiếp tục</p>
                </div>
                
                <form class="auth-form" id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" name="email" placeholder="Nhập địa chỉ email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Mật khẩu</label>
                        <input type="password" id="login-password" name="password" placeholder="Nhập mật khẩu" required>
                    </div>
                    
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <input type="checkbox" id="remember-me" name="remember">
                            <label for="remember-me" style="display: inline;">Ghi nhớ đăng nhập</label>
                        </div>
                        
                        <a href="#" style="color: var(--primary-color); text-decoration: none;">Quên mật khẩu?</a>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px;">Đăng nhập</button>
                    
                    <div class="divider">
                        <span>Hoặc đăng nhập với</span>
                    </div>
                    
                    <div class="social-login">
                        <button type="button" class="social-btn">
                            <i class="fab fa-google"></i>
                            <span>Google</span>
                        </button>
                        
                        <button type="button" class="social-btn">
                            <i class="fab fa-facebook-f"></i>
                            <span>Facebook</span>
                        </button>
                    </div>
                    
                    <div class="form-footer">
                        <p>Chưa có tài khoản? <a href="register.html">Đăng ký ngay</a></p>
                    </div>
                </form>
            </div>
        </div>
        <div id="footer"></div>         
    </main>

    <script>
        fetch("footer.html")
        .then(response => response.text())
        .then(data => {
            document.getElementById("footer").innerHTML = data;
        });
    </script>

    <script type="module">
        // 1. Import đầy đủ các thư viện cần thiết
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        signInWithPopup, // Dùng Popup cho đồng bộ với trang Đăng ký
        GoogleAuthProvider, 
        FacebookAuthProvider 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Cấu hình Firebase của bạn
    const firebaseConfig = {
        apiKey: "AIzaSyAR_mMEOLmcQeewl7ECynfLe-0ymFiqx9g",
        authDomain: "pj-luyen-noi-tieng-anh.firebaseapp.com",
        projectId: "pj-luyen-noi-tieng-anh",
        storageBucket: "pj-luyen-noi-tieng-anh.firebasestorage.app",
        messagingSenderId: "835156032196",
        appId: "1:835156032196:web:b8920adabf15ace0bbe791"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Hàm điều hướng thông minh
    async function handleLoginSuccess(user) {
        const userRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
            const role = userDoc.data().role;
            window.location.href = `${role}.html`;
        } else {
            // Nếu dùng GG/FB đăng nhập mà chưa có trong DB -> Mặc định là Learner
            await setDoc(userRef, {
                uid: user.uid,
                fullName: user.displayName || "Người dùng Google",
                email: user.email,
                role: "learner",
                createdAt: new Date().toISOString()
            });
            window.location.href = 'learner.html';
        }
    }

    // Xử lý Google Login
    const googleBtn = document.querySelector('.social-btn i.fa-google').parentElement;
    googleBtn.onclick = async () => {
        try {
            const result = await signInWithPopup(auth, new GoogleAuthProvider());
            await handleLoginSuccess(result.user);
        } catch (error) {
            console.error(error);
            alert("Lỗi đăng nhập Google: " + error.message);
        }
    };
    // Xử lý Facebook Login ở trang Login
    const facebookBtn = document.querySelector('.social-btn i.fa-facebook-f').parentElement;
    facebookBtn.onclick = async () => {
        try {
            const provider = new FacebookAuthProvider();
            const result = await signInWithPopup(auth, provider);
            // Sau khi đăng nhập FB thành công, dùng lại hàm check Role đã viết ở trên
            await handleLoginSuccess(result.user); 
        } catch (error) {
            console.error("Lỗi Facebook Login:", error.code);
            if (error.code === 'auth/account-exists-with-different-credential') {
                alert("Email này đã được đăng ký bằng Google. Vui lòng dùng Google để đăng nhập.");
            } else {
                alert("Lỗi Facebook: " + error.message);
            }
        }
    };

    // Xử lý Email Login truyền thống
    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
            const result = await signInWithEmailAndPassword(auth, email, password);
            await handleLoginSuccess(result.user);
        } catch (error) {
            alert("Sai tài khoản hoặc mật khẩu!");
        }
    };
    </script>
</body>
</html>