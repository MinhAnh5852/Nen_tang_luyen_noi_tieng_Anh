<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Gói dịch vụ - AESP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --primary-color: #4361ee;
        --dark-color: #1e293b;
        --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --radius: 12px;
      }
      body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; padding: 20px; color: var(--dark-color); }
      .container { max-width: 1100px; margin: 0 auto; }
      
      .current-plan {
        background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
        color: white; padding: 30px; border-radius: var(--radius);
        margin-bottom: 40px; box-shadow: var(--shadow);
      }
      
      .plans-grid {
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px; 
        margin-bottom: 40px;
      }

      .plan-card {
        background: white; border-radius: var(--radius); padding: 30px;
        box-shadow: var(--shadow); border: 2px solid #e5e7eb; position: relative;
        display: flex; flex-direction: column; transition: transform 0.3s ease;
      }
      .plan-card:hover { transform: translateY(-5px); }
      .plan-card.recommended { border-color: var(--primary-color); border-width: 3px; }
      
      .recommend-badge {
        position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
        background: #ff9f43; color: white; padding: 5px 15px;
        border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
      }
      
      .plan-price { font-size: 2.2rem; font-weight: 700; color: var(--dark-color); margin: 15px 0; }
      .plan-features-list { list-style: none; padding: 0; margin-bottom: 25px; flex-grow: 1; }
      .plan-features-list li { margin-bottom: 12px; font-size: 0.9rem; color: #475569; display: flex; align-items: center; }
      .plan-features-list i { color: #22c55e; margin-right: 10px; }

      .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: 0.3s; }
      .btn-primary { background: var(--primary-color); color: white; }
      .btn-primary:hover { background: #3a0ca3; }
      .btn-free { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; cursor: default; }

      .transaction-section { background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); }
      table { width: 100%; border-collapse: collapse; margin-top: 15px; }
      th { background: #f8fafc; padding: 15px; text-align: left; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
      td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
      
      .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
      .status-success { background: #dcfce7; color: #166534; }
      .status-pending { background: #fef9c3; color: #854d0e; }
      
      .loading-spinner { text-align: center; padding: 40px; color: #64748b; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="current-plan">
        <h2 style="margin: 0"><i class="fas fa-crown"></i> Gói dịch vụ của tôi</h2>
        <div id="plan-info" style="margin-top: 15px; font-size: 1.1rem; opacity: 0.9;">
            <i class="fas fa-circle-notch fa-spin"></i> Đang đồng bộ thông tin...
        </div>
      </div>

      <h2 style="margin-bottom: 25px; text-align: center;">Nâng cấp trải nghiệm học tập</h2>
      
      <div class="plans-grid" id="plans-container">
          <div class="loading-spinner"><i class="fas fa-circle-notch fa-spin fa-2x"></i></div>
      </div>

      <div class="transaction-section">
        <h3><i class="fas fa-history"></i> Lịch sử giao dịch</h3>
        <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Mã đơn</th>
                  <th>Ngày giao dịch</th>
                  <th>Số tiền</th>
                  <th>Phương thức</th>
                  <th>Trạng thái</th>
                </tr>
              </thead>
              <tbody id="transaction-list">
                <tr><td colspan="5" style="text-align: center; color: gray">Đang tải lịch sử...</td></tr>
              </tbody>
            </table>
        </div>
      </div>
    </div>

    <script>
      // Cấu hình Proxy qua API Gateway (80)
      const API_SUB = "http://localhost/api/subscriptions";
      const API_PAY = "http://localhost/api/payments";

      // 1. Tải các gói từ subscription-service
      async function fetchSubscriptionPlans() {
        const container = document.getElementById("plans-container");
        try {
          const response = await fetch(`${API_SUB}/plans`);
          if (!response.ok) throw new Error("Không thể kết nối Server gói");
          
          const plans = await response.json();
          container.innerHTML = "";

          // Sắp xếp Free -> Basic -> Pro
          plans.sort((a, b) => a.price - b.price);

          plans.forEach(plan => {
            if (plan.is_active) {
              const features = plan.features ? plan.features.split(',') : [];
              const isFree = plan.price === 0;
              const isRecommended = plan.badge_text !== null;

              const card = `
                <div class="plan-card ${isRecommended ? 'recommended' : ''}">
                  ${isRecommended ? `<div class="recommend-badge">${plan.badge_text}</div>` : ''}
                  <h3 style="margin-top: 0">${plan.name}</h3>
                  <div class="plan-price">
                    ${isFree ? '0đ' : plan.price.toLocaleString('vi-VN') + 'đ'}
                    <span style="font-size: 0.9rem; color: #94a3b8; font-weight: 400">
                        ${isFree ? '' : ' / ' + plan.duration_days + ' ngày'}
                    </span>
                  </div>
                  <ul class="plan-features-list">
                    ${features.map(f => `<li><i class="fas fa-check-circle"></i> ${f.trim()}</li>`).join('')}
                  </ul>
                  <button class="btn ${isFree ? 'btn-free' : 'btn-primary'}" 
                          onclick="${isFree ? '' : `handleCheckout('${plan.id}', ${plan.price})`}">
                    ${isFree ? 'Gói mặc định' : 'Nâng cấp ngay'}
                  </button>
                </div>
              `;
              container.insertAdjacentHTML('beforeend', card);
            }
          });
        } catch (e) {
          container.innerHTML = `<div style="text-align:center; color:red; width:100%">Lỗi: ${e.message}</div>`;
        }
      }

      // 2. Tải lịch sử giao dịch từ payment-service
      async function fetchUserTransactions() {
        const info = JSON.parse(localStorage.getItem("user_info"));
        const list = document.getElementById("transaction-list");
        if (!info || !info.id) {
            list.innerHTML = '<tr><td colspan="5" style="text-align:center">Vui lòng đăng nhập</td></tr>';
            return;
        }

        try {
          // Ép kiểu ID sang Number để tránh lỗi 422
          const res = await fetch(`${API_PAY}/history/${Number(info.id)}`);
          if (!res.ok) throw new Error("Lỗi tải lịch sử");
          
          const txs = await res.json();
          list.innerHTML = txs.length ? "" : '<tr><td colspan="5" style="text-align:center">Chưa có giao dịch nào</td></tr>';
          
          txs.forEach(tx => {
            list.insertAdjacentHTML('beforeend', `
              <tr>
                <td style="font-family: monospace; font-weight: bold;">#${tx.id.substring(0, 8).toUpperCase()}</td>
                <td>${new Date(tx.created_at).toLocaleString('vi-VN')}</td>
                <td><strong>${tx.amount.toLocaleString()}đ</strong></td>
                <td><i class="fas fa-wallet"></i> ${tx.method}</td>
                <td>
                    <span class="status-badge ${tx.status==='SUCCESS'?'status-success':'status-pending'}">
                        ${tx.status === 'SUCCESS' ? 'THÀNH CÔNG' : 'ĐANG CHỜ'}
                    </span>
                </td>
              </tr>
            `);
          });
        } catch (e) { 
            list.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red">Lỗi kết nối lịch sử</td></tr>`;
        }
      }

      // 3. Tải trạng thái gói hiện tại của User
      async function fetchCurrentStatus() {
        const info = JSON.parse(localStorage.getItem("user_info"));
        const planInfo = document.getElementById("plan-info");
        if (!info) return;

        try {
          const res = await fetch(`${API_SUB}/status/${Number(info.id)}`);
          if (!res.ok) throw new Error();
          
          const data = await res.json();
          planInfo.innerHTML = data.plan_name 
            ? `Bạn đang sử dùng: <strong>${data.plan_name}</strong> • Hạn dùng đến: <strong>${new Date(data.expired_at).toLocaleDateString('vi-VN')}</strong>`
            : "Bạn đang sử dụng gói Miễn phí. Nâng cấp để mở khóa AI không giới hạn!";
        } catch (e) { 
            planInfo.innerHTML = "Không thể đồng bộ thông tin gói. Vui lòng thử lại sau.";
        }
      }

      // 4. Xử lý khi nhấn nút Nâng cấp
      function handleCheckout(planId, price) {
        // Lưu thông tin gói vào tạm thời để trang thanh toán sử dụng
        localStorage.setItem("pending_plan", JSON.stringify({ id: planId, price: price }));
        
        // Hiệu ứng chuyển trang
        document.body.style.opacity = '0.5';
        setTimeout(() => {
            window.location.href = "payment.html"; // Chuyển sang trang thanh toán của bạn
        }, 500);
      }

      // Khởi chạy khi trang sẵn sàng
      document.addEventListener("DOMContentLoaded", () => {
        fetchCurrentStatus();
        fetchSubscriptionPlans();
        fetchUserTransactions();
      });
    </script>
  </body>
</html>