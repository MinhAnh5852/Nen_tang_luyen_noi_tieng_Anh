<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/resources.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ƒê·∫£m b·∫£o Modal hi·ªÉn th·ªã ƒë√∫ng tr√™n iframe */
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-backdrop.show { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin-top: 5px; box-sizing: border-box; font-family: inherit; }
        .form-row { margin-bottom: 15px; }
        .modal-ft { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <div>
                <h1 class="page-title">Kho T√†i Li·ªáu Chuy√™n M√¥n</h1>
                <p style="color: var(--muted); font-size: 13px; margin-top: 4px;">Cung c·∫•p t√†i li·ªáu b·ªï tr·ª£ cho h·ªçc vi√™n ƒë·ªÉ c·∫£i thi·ªán k·ªπ nƒÉng n√≥i.</p>
            </div>
            <button class="btn btn-primary" onclick="openResourceModal()">
                <i class="fa-solid fa-cloud-arrow-up"></i> T·∫£i t√†i li·ªáu l√™n
            </button>
        </div>

        <div class="filter-bar" style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); display: flex; gap: 15px;">
            <div class="search-wrapper" style="flex: 1; position: relative;">
                <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
                <input type="text" id="resourceSearch" onkeyup="filterResources()" placeholder="T√¨m ki·∫øm gi√°o tr√¨nh, b√†i t·∫≠p..." class="form-control" style="padding-left: 35px; margin: 0;">
            </div>
            <select id="filterType" class="form-control" style="width: 200px; margin: 0;" onchange="filterResources()">
                <option value="">T·∫•t c·∫£ ƒë·ªãnh d·∫°ng</option>
                <option value="PDF">T·ªáp PDF</option>
                <option value="Video">Video b√†i gi·∫£ng</option>
                <option value="Link">Li√™n k·∫øt ngo√†i</option>
            </select>
        </div>

        <div id="resources-grid" class="resources-grid-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
            <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--muted);">
                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i kho t√†i li·ªáu...
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="resourceModal">
        <div class="modal">
            <div class="modal-hd" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <h3 style="margin:0;"><i class="fa-solid fa-file-circle-plus"></i> Th√™m t√†i li·ªáu m·ªõi</h3>
                <i class="fa-solid fa-xmark" onclick="closeResourceModal()" style="cursor:pointer; color: #94a3b8;"></i>
            </div>
            <div class="modal-bd" style="padding-top: 20px;">
                <div class="form-row">
                    <label style="font-weight: 700;">T√™n t√†i li·ªáu:</label>
                    <input type="text" id="res-title" class="form-control" placeholder="VD: 100 Collocations th√¥ng d·ª•ng">
                </div>
                <div class="form-row">
                    <label style="font-weight: 700;">Lo·∫°i t√†i li·ªáu:</label>
                    <select id="res-type" class="form-control">
                        <option value="PDF">T·ªáp PDF (T√†i li·ªáu ƒë·ªçc)</option>
                        <option value="Video">Video (Luy·ªán nghe/ph√°t √¢m)</option>
                        <option value="Link">Li√™n k·∫øt ngo√†i (Websites)</option>
                    </select>
                </div>
                <div class="form-row">
                    <label style="font-weight: 700;">M√¥ t·∫£ ng·∫Øn:</label>
                    <textarea id="res-desc" class="form-control" rows="2" placeholder="G·ª£i √Ω c√°ch s·ª≠ d·ª•ng t√†i li·ªáu n√†y..."></textarea>
                </div>
                <div class="form-row">
                    <label style="font-weight: 700;">ƒê∆∞·ªùng d·∫´n (URL):</label>
                    <input type="text" id="res-url" class="form-control" placeholder="https://example.com/file.pdf">
                </div>
            </div>
            <div class="modal-ft">
                <button class="btn btn-outline" onclick="closeResourceModal()">H·ªßy</button>
                <button id="btn-save-res" class="btn btn-primary" onclick="handleUploadResource()">L∆∞u v√†o kho</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/mentors';
        const token = localStorage.getItem('token');

        // H√†m ·∫©n hi·ªán Modal n·ªôi b·ªô
        function openResourceModal() { document.getElementById('resourceModal').classList.add('show'); }
        function closeResourceModal() { document.getElementById('resourceModal').classList.remove('show'); }

        // 1. H√†m n·∫°p d·ªØ li·ªáu t·ª´ Backend
        window.init_resources = async function() {
            const grid = document.getElementById('resources-grid');
            try {
                // S·ª≠ d·ª•ng ƒë√∫ng API Mentor Service
                const res = await fetch(`${API_BASE}/resources`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error("API Error: " + res.status);
                const data = await res.json();

                if (!data || data.length === 0) {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; font-weight:700; color:var(--muted);">üì≠ Kho t√†i li·ªáu hi·ªán ƒëang tr·ªëng.</div>';
                    return;
                }

                grid.innerHTML = data.map(item => {
                    let icon = 'fa-file-pdf';
                    let color = '#ef4444';
                    const type = item.skill_type || 'PDF';
                    if(type === 'Video') { icon = 'fa-circle-play'; color = '#3b82f6'; }
                    if(type === 'Link') { icon = 'fa-link'; color = '#10b981'; }

                    return `
                    <div class="resource-card" data-type="${type}" style="background:white; padding:20px; border-radius:15px; border:1px solid var(--border); display:flex; gap:15px; transition:0.3s;">
                        <div class="resource-icon" style="color: ${color}; font-size: 24px; background: #f8fafc; width: 50px; height: 50px; border-radius: 10px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div class="resource-info" style="flex:1;">
                            <h4 style="margin:0 0 5px 0; font-size:15px; font-weight:800; color: var(--text-main);">${item.title}</h4>
                            <p style="font-size:12px; color:var(--muted); margin-bottom:12px; height: 36px; overflow: hidden;">${item.description || 'T√†i li·ªáu h·ªó tr·ª£ luy·ªán n√≥i.'}</p>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size:10px; font-weight:900; background:#f1f5f9; color: #475569; padding:2px 8px; border-radius:4px;">${type.toUpperCase()}</span>
                                <a href="${item.link}" target="_blank" style="color:var(--primary); font-size:12px; font-weight:700; text-decoration:none;">Xem t√†i li·ªáu <i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                console.error("L·ªói:", e);
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red; padding:40px; font-weight:900;">‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß t√†i li·ªáu (404).</div>';
            }
        };

        // 2. X·ª≠ l√Ω th√™m t√†i li·ªáu m·ªõi
        async function handleUploadResource() {
            const btn = document.getElementById('btn-save-res');
            const payload = {
                title: document.getElementById('res-title').value,
                skill_type: document.getElementById('res-type').value,
                description: document.getElementById('res-desc').value,
                link: document.getElementById('res-url').value // S·ª≠a: G·ª≠i tr∆∞·ªùng 'link' thay v√¨ 'url' ƒë·ªÉ kh·ªõp Backend
            };

            if(!payload.title || !payload.link) return alert("Vui l√≤ng nh·∫≠p t√™n v√† ƒë∆∞·ªùng d·∫´n t√†i li·ªáu!");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...';

            try {
                const res = await fetch(`${API_BASE}/resources`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("‚úÖ ƒê√£ th√™m t√†i li·ªáu th√†nh c√¥ng!");
                    closeResourceModal();
                    init_resources();
                    // Reset form
                    document.getElementById('res-title').value = '';
                    document.getElementById('res-url').value = '';
                    document.getElementById('res-desc').value = '';
                } else {
                    alert("‚ùå L·ªói: Kh√¥ng th·ªÉ l∆∞u t√†i li·ªáu. Ki·ªÉm tra quy·ªÅn h·∫°n Mentor.");
                }
            } catch (e) {
                alert("‚ùå L·ªói k·∫øt n·ªëi h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i sau.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'L∆∞u v√†o kho';
            }
        }

        // 3. H√†m l·ªçc t√†i li·ªáu
        function filterResources() {
            const key = document.getElementById('resourceSearch').value.toLowerCase();
            const type = document.getElementById('filterType').value;
            const cards = document.querySelectorAll('.resource-card');
            
            cards.forEach(c => {
                const title = c.querySelector('h4').innerText.toLowerCase();
                const cardType = c.getAttribute('data-type');
                const matchKey = title.includes(key);
                const matchType = type === "" || cardType === type;
                c.style.display = (matchKey && matchType) ? 'flex' : 'none';
            });
        }

        // T·ª± ƒë·ªông n·∫°p d·ªØ li·ªáu khi v√†o trang
        init_resources();
    </script>
</body>
</html>