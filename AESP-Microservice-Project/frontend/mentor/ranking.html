<link rel="stylesheet" href="css/ranking.css">

<div class="page-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
    <div>
        <h1 style="font-size: 28px; font-weight: 900; color: #1e293b; margin: 0;">üèÜ B·∫£ng V√†ng AESP</h1>
        <p style="color: #64748b; margin-top: 6px; font-size: 14px;">Vinh danh nh·ªØng h·ªçc vi√™n chƒÉm ch·ªâ v√† c√≥ th√†nh t√≠ch xu·∫•t s·∫Øc nh·∫•t.</p>
    </div>
    <button class="btn btn-primary" onclick="init_ranking()" style="padding: 12px 20px; border-radius: 12px; font-weight: 700; background: #4f46e5; color: white; border: none; cursor: pointer;">
        <i class="fa-solid fa-sync"></i> T·∫£i l·∫°i d·ªØ li·ªáu
    </button>
</div>



<div class="table-card">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 100px;">H·∫°ng</th>
                <th>H·ªçc vi√™n</th>
                <th>Tr√¨nh ƒë·ªô</th>
                <th>Chu·ªói ng√†y (Streak)</th>
                <th style="text-align: right;">T·ªïng ƒëi·ªÉm t√≠ch l≈©y</th>
            </tr>
        </thead>
        <tbody id="leaderboard-tbody">
            <tr>
                <td colspan="5" style="text-align:center; padding: 100px; color: #94a3b8;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 15px; font-weight: 600;">ƒêang t√≠nh to√°n b·∫£ng x·∫øp h·∫°ng...</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    window.init_ranking = async function() {
        const tbody = document.getElementById('leaderboard-tbody');
        const token = localStorage.getItem('token');
        
        try {
            const res = await fetch('/api/users/leaderboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!res.ok) throw new Error("API Error");
            const users = await res.json();
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px; font-weight:700;">üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map((user, index) => {
                const rank = index + 1;
                let rankHTML = `<div class="rank-box">${rank}</div>`;
                let rowBg = '';

                if(rank === 1) {
                    rankHTML = `<div class="rank-box rank-1">ü•á</div>`;
                    rowBg = 'background-color: #fffef3;'; 
                } else if(rank === 2) {
                    rankHTML = `<div class="rank-box rank-2">ü•à</div>`;
                } else if(rank === 3) {
                    rankHTML = `<div class="rank-box rank-3">ü•â</div>`;
                }

                const name = user.username || 'H·ªçc vi√™n';
                const firstLetter = name.charAt(0).toUpperCase();

                return `
                <tr style="${rowBg}">
                    <td style="padding: 15px 20px;">${rankHTML}</td>
                    <td style="padding: 15px 20px;">
                        <div class="user-info">
                            <div class="avatar-circle">${firstLetter}</div>
                            <div style="display: flex; flex-direction: column;">
                                <span style="font-weight: 800; color: #1e293b;">${name}</span>
                                <span style="font-size: 11px; color: #94a3b8; font-weight: 600;">H·ªçc vi√™n ch√≠nh th·ª©c</span>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 15px 20px;">
                        <span style="background:#e0e7ff; color:#4361ee; font-weight:800; padding:6px 14px; border-radius:12px; font-size:12px;">
                            ${user.level || 'A1'}
                        </span>
                    </td>
                    <td style="padding: 15px 20px;">
                        <div class="streak-info">
                            <i class="fas fa-fire"></i>
                            <span>${user.streak || 0} ng√†y</span>
                        </div>
                    </td>
                    <td style="padding: 15px 20px; text-align: right;">
                        <div class="point-badge">
                            ${(user.points || 0).toLocaleString()} <span style="font-size:10px; opacity:0.7; margin-left:2px;">pts</span>
                        </div>
                    </td>
                </tr>`;
            }).join('');

        } catch(e) { 
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px; color:#ef4444; font-weight:800;">‚ö†Ô∏è L·ªói k·∫øt n·ªëi t·ªõi h·ªá th·ªëng d·ªØ li·ªáu.</td></tr>'; 
        }
    }

    init_ranking();
</script>