<link rel="stylesheet" href="css/ranking.css">
<div class="page-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
    <div>
        <h1 style="font-size: 24px; font-weight: 900; color: var(--text);">üèÜ B·∫£ng X·∫øp H·∫°ng H·ªçc Vi√™n</h1>
        <p style="color: var(--muted); margin-top: 4px; font-size: 13px;">Vinh danh nh·ªØng n·ªó l·ª±c luy·ªán t·∫≠p kh√¥ng ng·ª´ng ngh·ªâ c·ªßa h·ªçc vi√™n AESP.</p>
    </div>
    <button class="btn btn-primary" onclick="init_ranking()">
        <i class="fa-solid fa-sync"></i> T·∫£i l·∫°i d·ªØ li·ªáu
    </button>
</div>

<div class="table-card" style="padding: 20px; border-radius: 16px; background: white;">
    <table class="data-table">
        <thead>
            <tr style="text-align: left; border-bottom: 2px solid var(--border);">
                <th style="padding: 15px;">H·∫°ng</th>
                <th style="padding: 15px;">H·ªçc vi√™n</th>
                <th style="padding: 15px;">Tr√¨nh ƒë·ªô</th>
                <th style="padding: 15px;">Chu·ªói ng√†y</th>
                <th style="padding: 15px; text-align: right;">T·ªïng ƒëi·ªÉm</th>
            </tr>
        </thead>
        <tbody id="leaderboard-tbody">
            <tr>
                <td colspan="5" style="text-align:center; padding: 40px; color: var(--muted);">
                    <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i b·∫£ng v√†ng AESP...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    // 1. H√†m kh·ªüi t·∫°o n·∫°p d·ªØ li·ªáu x·∫øp h·∫°ng
    window.init_ranking = async function() {
        const tbody = document.getElementById('leaderboard-tbody');
        
        try {
            // G·ªçi ƒë√∫ng endpoint b·∫£ng x·∫øp h·∫°ng c·ªßa h·ªá th·ªëng
            const res = await fetch('/api/users/leaderboard', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            
            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu");
            
            const users = await res.json();
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">Ch∆∞a c√≥ h·ªçc vi√™n n√†o tham gia x·∫øp h·∫°ng.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map((user) => {
                // X·ª≠ l√Ω icon h·∫°ng Top 3 gi·ªëng Leaderboard.tsx
                let rankDisplay = user.rank;
                if(user.rank === 1) rankDisplay = 'ü•á';
                else if(user.rank === 2) rankDisplay = 'ü•à';
                else if(user.rank === 3) rankDisplay = 'ü•â';

                // N·ªÅn v√†ng nh·∫π cho Top 3
                const rowStyle = user.rank <= 3 ? 'background-color: #fffbeb;' : '';

                return `
                <tr style="border-bottom: 1px solid #f9f9f9; ${rowStyle}">
                    <td style="padding: 15px; font-weight: 900; font-size: 1.1rem;">${rankDisplay}</td>
                    <td style="padding: 15px; font-weight: 700; color: var(--text);">${user.username}</td>
                    <td style="padding: 15px;">
                        <span class="badge" style="background:#e0e7ff; color:#4361ee; font-weight:700; padding:4px 12px; border-radius:99px;">
                            ${user.level || 'A1'}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <i class="fas fa-fire" style="color: #ef4444; margin-right: 5px;"></i> 
                        <strong>${user.streak || 0}</strong>
                    </td>
                    <td style="padding: 15px; font-weight: 900; color: #2563eb; text-align: right;">
                        ${(user.points || 0).toLocaleString()}
                    </td>
                </tr>`;
            }).join('');

        } catch(e) { 
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:red;">‚ö†Ô∏è L·ªói k·∫øt n·ªëi API B·∫£ng x·∫øp h·∫°ng.</td></tr>'; 
        }
    }

    // T·ª± ƒë·ªông ch·∫°y khi n·∫°p trang
    init_ranking();
</script>