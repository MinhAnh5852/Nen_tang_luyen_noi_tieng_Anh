<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/tasks.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-backdrop.show { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; box-sizing: border-box; font-family: inherit; }
        .form-row { margin-bottom: 15px; }
        .modal-ft { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        /* Badge tr·∫°ng th√°i m·ªõi */
        .badge-pending { background: #fff7ed; color: #ea580c; padding: 4px 12px; border-radius: 8px; font-weight: 800; font-size: 11px; border: 1px solid #ffedd5; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
                <h1 class="page-title">Qu·∫£n L√Ω B√†i T·∫≠p</h1>
                <p class="page-subtitle">Giao c√°c t√¨nh hu·ªëng h·ªôi tho·∫°i th·ª±c t·∫ø cho h·ªçc vi√™n c·ªßa b·∫°n.</p>
            </div>
            <button class="btn btn-primary" onclick="openLocalModal()">
                <i class="fa-solid fa-plus"></i> T·∫°o b√†i t·∫≠p m·ªõi
            </button>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Ti√™u ƒë·ªÅ b√†i t·∫≠p</th>
                        <th>H·ªçc vi√™n m·ª•c ti√™u</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H·∫°n n·ªôp</th>
                        <th class="text-right">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="tasks-tbody">
                    <tr>
                        <td colspan="5" style="text-align:center; padding:40px; color: var(--muted);">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang n·∫°p danh s√°ch b√†i t·∫≠p...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="createTaskModal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-hd" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <h3 style="margin:0;"><i class="fa-solid fa-paper-plane"></i> Giao b√†i t·∫≠p m·ªõi</h3>
                <i class="fa-solid fa-xmark" onclick="closeLocalModal()" style="cursor:pointer; font-size: 20px; color: #999;"></i>
            </div>
            <div class="modal-bd" style="padding-top: 20px;">
                <div class="form-row">
                    <label style="font-weight: 700;">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label>
                    <input type="text" id="task-title" class="form-control" placeholder="V√≠ d·ª•: Luy·ªán h·ªôi tho·∫°i ph·ªèng v·∫•n xin vi·ªác">
                </div>
                
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-row">
                        <label style="font-weight: 700;">Lƒ©nh v·ª±c:</label>
                        <select id="task-topic" class="form-control">
                            <option value="Work">C√¥ng vi·ªác</option>
                            <option value="Travel">Du l·ªãch</option>
                            <option value="Daily Life">ƒê·ªùi s·ªëng</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="font-weight: 700;">H·ªçc vi√™n nh·∫≠n b√†i:</label>
                        <select id="task-learner" class="form-control">
                            <option value="ALL">--- T·∫•t c·∫£ h·ªçc vi√™n c·ªßa t√¥i ---</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <label style="font-weight: 700;">Y√™u c·∫ßu chi ti·∫øt:</label>
                    <textarea id="task-req" class="form-control" rows="3" placeholder="H√£y m√¥ t·∫£ b·ªëi c·∫£nh ho·∫∑c l∆∞u √Ω cho h·ªçc vi√™n..."></textarea>
                </div>

                <div class="form-row">
                    <label style="font-weight: 700;">H·∫°n ho√†n th√†nh:</label>
                    <input type="date" id="task-deadline" class="form-control">
                </div>
            </div>
            <div class="modal-ft">
                <button class="btn btn-outline" onclick="closeLocalModal()">H·ªßy</button>
                <button id="btn-submit-task" class="btn btn-primary" onclick="handleCreateTask()">
                    <i class="fa-solid fa-check"></i> X√°c nh·∫≠n giao b√†i
                </button>
            </div>
        </div>
    </div>

    <script>
        // ƒê·ªìng b·ªô API_BASE v·ªÅ User Service (N∆°i qu·∫£n l√Ω Learner-Mentor)
        const API_BASE = '/api/users/mentors'; 
        const token = localStorage.getItem('token');
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const mentorId = userInfo.id || userInfo.user_id;

        let learnersList = []; 

        function openLocalModal() { document.getElementById('createTaskModal').classList.add('show'); }
        function closeLocalModal() { document.getElementById('createTaskModal').classList.remove('show'); }

        // 1. N·∫°p danh s√°ch h·ªçc vi√™n ƒê√É K·∫æT N·ªêI v·ªõi Mentor n√†y
        async function loadLearnersForSelect() {
            if (!mentorId) return;
            try {
                const res = await fetch(`${API_BASE}/my-learners/${mentorId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const select = document.getElementById('task-learner');
                
                // Reset select v√† th√™m option ALL
                select.innerHTML = '<option value="ALL">--- T·∫•t c·∫£ h·ªçc vi√™n c·ªßa t√¥i ---</option>';
                data.forEach(l => {
                    select.innerHTML += `<option value="${l.id}">${l.username} (${l.email})</option>`;
                });
                
                // L∆∞u danh s√°ch ƒë·ªÉ d√πng cho logic giao b√†i h√†ng lo·∫°t
                learnersList = data;
            } catch(e) { console.error("L·ªói n·∫°p danh s√°ch h·ªçc vi√™n:", e); }
        }

        // 2. L·∫•y l·ªãch s·ª≠ c√°c b√†i t·∫≠p ƒë√£ giao
        window.init_tasks = async function() {
            const tbody = document.getElementById('tasks-tbody');
            try {
                const res = await fetch(`${API_BASE}/tasks`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted); font-weight:700;">üì≠ Hi·ªán t·∫°i b·∫°n ch∆∞a giao b√†i t·∫≠p n√†o.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(t => `
                    <tr>
                        <td><strong style="color:var(--text-main); font-size:14px;">${t.title}</strong></td>
                        <td><span style="font-weight:600; color:#475569;">${t.learner_name || 'Giao chung'}</span></td>
                        <td><span class="badge-pending">${t.status}</span></td>
                        <td style="color:var(--muted); font-weight:600;">${t.deadline ? t.deadline.split(' ')[0] : 'V√¥ th·ªùi h·∫°n'}</td>
                        <td class="text-right">
                            <button class="action-btn btn-delete" onclick="deleteTask('${t.id}')">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>`).join('');
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red; padding:20px; font-weight:900;">‚ö†Ô∏è L·ªói k·∫øt n·ªëi h·ªá th·ªëng d·ªØ li·ªáu b√†i t·∫≠p.</td></tr>';
            }
        };

        // 3. X·ª≠ l√Ω logic Giao b√†i t·∫≠p
        async function handleCreateTask() {
            const btn = document.getElementById('btn-submit-task');
            const selectLearner = document.getElementById('task-learner');
            const selectedValue = selectLearner.value;
            
            const payload = {
                title: document.getElementById('task-title').value.trim(),
                description: document.getElementById('task-req').value.trim(),
                deadline: document.getElementById('task-deadline').value,
                topic: document.getElementById('task-topic').value
            };

            if(!payload.title || !payload.deadline) return alert("Vui l√≤ng ƒëi·ªÅn ti√™u ƒë·ªÅ v√† h·∫°n n·ªôp b√†i!");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

            try {
                if (selectedValue === "ALL") {
                    if (learnersList.length === 0) throw new Error("B·∫°n ch∆∞a c√≥ h·ªçc vi√™n n√†o ƒë·ªÉ giao b√†i.");
                    
                    // Logic: L·∫∑p v√† giao b√†i cho t·ª´ng ng∆∞·ªùi trong danh s√°ch k·∫øt n·ªëi
                    for (let learner of learnersList) {
                        await fetch(`${API_BASE}/tasks`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                ...payload, 
                                learner_id: learner.id, 
                                learner_name: learner.username 
                            })
                        });
                    }
                } else {
                    // Giao cho m·ªôt c√° nh√¢n c·ª• th·ªÉ
                    const res = await fetch(`${API_BASE}/tasks`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            ...payload, 
                            learner_id: selectedValue, 
                            learner_name: selectLearner.options[selectLearner.selectedIndex].text.split(' (')[0] 
                        })
                    });
                    if (!res.ok) throw new Error("L·ªói l∆∞u tr·ªØ ph√≠a Server.");
                }

                alert("‚úÖ B√†i t·∫≠p ƒë√£ ƒë∆∞·ª£c ph√°t h√†nh th√†nh c√¥ng!");
                closeLocalModal();
                init_tasks();
                // Reset form
                document.getElementById('task-title').value = '';
                document.getElementById('task-req').value = '';
            } catch (e) {
                alert("‚ùå L·ªói: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Giao b√†i t·∫≠p';
            }
        }

        async function deleteTask(id) {
            if(!confirm("H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. X√≥a b√†i t·∫≠p n√†y?")) return;
            try {
                const res = await fetch(`${API_BASE}/tasks/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) init_tasks();
                else alert("Kh√¥ng th·ªÉ x√≥a b√†i t·∫≠p v√†o l√∫c n√†y.");
            } catch(e) { console.error(e); }
        }

        // Kh·ªüi t·∫°o trang
        loadLearnersForSelect();
        init_tasks();
    </script>
</body>
</html>