<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/tasks.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-backdrop.show { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; box-sizing: border-box; font-family: inherit; }
        .form-row { margin-bottom: 15px; }
        .modal-ft { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .badge-pending { background: #fff3e0; color: #ef6c00; padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 11px; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
                <h1 class="page-title">Qu·∫£n L√Ω B√†i T·∫≠p</h1>
                <p class="page-subtitle">Giao c√°c t√¨nh hu·ªëng h·ªôi tho·∫°i th·ª±c t·∫ø cho h·ªçc vi√™n luy·ªán t·∫≠p.</p>
            </div>
            <button class="btn btn-primary" onclick="openLocalModal()">
                <i class="fa-solid fa-plus"></i> T·∫°o b√†i t·∫≠p m·ªõi
            </button>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Ti√™u ƒë·ªÅ b√†i t·∫≠p</th>
                        <th>H·ªçc vi√™n</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H·∫°n n·ªôp</th>
                        <th class="text-right">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="tasks-tbody">
                    <tr>
                        <td colspan="5" style="text-align:center; padding:40px; color: var(--muted);">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang n·∫°p d·ªØ li·ªáu...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="createTaskModal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-hd" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <h3 style="margin:0;"><i class="fa-solid fa-pen-to-square"></i> Ph√°t h√†nh b√†i t·∫≠p</h3>
                <i class="fa-solid fa-xmark" onclick="closeLocalModal()" style="cursor:pointer; font-size: 20px; color: #999;"></i>
            </div>
            <div class="modal-bd" style="padding-top: 20px;">
                <div class="form-row">
                    <label style="font-weight: 700;">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label>
                    <input type="text" id="task-title" class="form-control" placeholder="V√≠ d·ª•: Ph·ªèng v·∫•n xin vi·ªác t·∫°i Google">
                </div>
                
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-row">
                        <label style="font-weight: 700;">Ch·ªß ƒë·ªÅ:</label>
                        <select id="task-topic" class="form-control">
                            <option value="Work">C√¥ng vi·ªác</option>
                            <option value="Travel">Du l·ªãch</option>
                            <option value="Daily Life">ƒê·ªùi s·ªëng</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="font-weight: 700;">H·ªçc vi√™n m·ª•c ti√™u:</label>
                        <select id="task-learner" class="form-control">
                            <option value="ALL">--- T·∫•t c·∫£ h·ªçc vi√™n ---</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <label style="font-weight: 700;">M√¥ t·∫£ y√™u c·∫ßu chi ti·∫øt:</label>
                    <textarea id="task-req" class="form-control" rows="3" placeholder="G·ª£i √Ω: H√£y s·ª≠ d·ª•ng √≠t nh·∫•t 3 t·ª´ v·ª±ng chuy√™n ng√†nh..."></textarea>
                </div>

                <div class="form-row">
                    <label style="font-weight: 700;">H·∫°n ho√†n th√†nh:</label>
                    <input type="date" id="task-deadline" class="form-control">
                </div>
            </div>
            <div class="modal-ft">
                <button class="btn btn-outline" onclick="closeLocalModal()">H·ªßy b·ªè</button>
                <button id="btn-submit-task" class="btn btn-primary" onclick="handleCreateTask()">
                    <i class="fa-solid fa-paper-plane"></i> Giao b√†i t·∫≠p
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/mentors';
        const token = localStorage.getItem('token');
        let learnersList = []; // L∆∞u tr·ªØ danh s√°ch h·ªçc vi√™n ƒë·ªÉ d√πng khi giao cho "T·∫•t c·∫£"

        function openLocalModal() { document.getElementById('createTaskModal').classList.add('show'); }
        function closeLocalModal() { document.getElementById('createTaskModal').classList.remove('show'); }

        // 1. N·∫°p danh s√°ch h·ªçc vi√™n cho √¥ Select
        async function loadLearnersForSelect() {
            try {
                const res = await fetch(`${API_BASE}/learners-list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                learnersList = await res.json();
                const select = document.getElementById('task-learner');
                learnersList.forEach(l => {
                    select.innerHTML += `<option value="${l.id}">${l.full_name} (${l.email})</option>`;
                });
            } catch(e) { console.error("L·ªói n·∫°p danh s√°ch h·ªçc vi√™n:", e); }
        }

        // 2. L·∫•y danh s√°ch b√†i t·∫≠p t·ª´ Backend
        window.init_tasks = async function() {
            const tbody = document.getElementById('tasks-tbody');
            try {
                const res = await fetch(`${API_BASE}/tasks`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--muted); font-weight:700;">üì≠ Hi·ªán ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(t => `
                    <tr>
                        <td><strong style="color:var(--text);">${t.title}</strong></td>
                        <td>${t.learner_name || 'Chung'}</td>
                        <td><span class="badge-pending">${t.status}</span></td>
                        <td style="color:var(--muted); font-weight:600;">${t.deadline}</td>
                        <td class="text-right">
                            <button class="action-btn btn-delete" onclick="deleteTask('${t.id}')" style="color:#ef4444; border:none; background:none; cursor:pointer; font-size:16px;">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>`).join('');
            } catch(e) {
                console.error("L·ªói API:", e);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red; padding:20px; font-weight:900;">‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Mentor Service.</td></tr>';
            }
        };

        // 3. H√†m g·ª≠i b√†i t·∫≠p (X·ª≠ l√Ω l·ªói Foreign Key "ALL")
        async function handleCreateTask() {
            const btn = document.getElementById('btn-submit-task');
            const selectLearner = document.getElementById('task-learner');
            const selectedValue = selectLearner.value;
            
            const basePayload = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-req').value,
                deadline: document.getElementById('task-deadline').value
            };

            if(!basePayload.title || !basePayload.deadline) return alert("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† ch·ªçn h·∫°n n·ªôp!");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

            try {
                // N·∫øu ch·ªçn "T·∫•t c·∫£", h·ªá th·ªëng s·∫Ω l·∫∑p qua danh s√°ch h·ªçc vi√™n ƒë·ªÉ tr√°nh l·ªói kh√≥a ngo·∫°i
                if (selectedValue === "ALL") {
                    if (learnersList.length === 0) throw new Error("Kh√¥ng c√≥ h·ªçc vi√™n ƒë·ªÉ giao b√†i.");
                    
                    for (let learner of learnersList) {
                        await fetch(`${API_BASE}/tasks`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...basePayload, learner_id: learner.id, learner_name: learner.full_name })
                        });
                    }
                } else {
                    // Giao cho m·ªôt ng∆∞·ªùi c·ª• th·ªÉ
                    const res = await fetch(`${API_BASE}/tasks`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            ...basePayload, 
                            learner_id: selectedValue, 
                            learner_name: selectLearner.options[selectLearner.selectedIndex].text 
                        })
                    });
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || "L·ªói server");
                    }
                }

                alert("‚úÖ ƒê√£ ph√°t h√†nh b√†i t·∫≠p th√†nh c√¥ng!");
                closeLocalModal();
                init_tasks();
            } catch (e) {
                alert("‚ùå L·ªói: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Giao b√†i t·∫≠p';
            }
        }

        async function deleteTask(id) {
            if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i t·∫≠p n√†y?")) return;
            alert("T√≠nh nƒÉng x√≥a ƒëang ƒë∆∞·ª£c ƒë·ªìng b·ªô v·ªõi API!");
        }

        // Kh·ªüi t·∫°o n·∫°p d·ªØ li·ªáu
        loadLearnersForSelect();
        init_tasks();
    </script>
</body>
</html>