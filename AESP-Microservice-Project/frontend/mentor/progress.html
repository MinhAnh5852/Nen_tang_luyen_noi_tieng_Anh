<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS HO√ÄN CH·ªàNH CHO TRANG TI·∫æN ƒê·ªò --- */
        :root {
            --primary: #4f46e5;
            --primary-soft: #eef2ff;
            --success: #10b981;
            --warning: #f59e0b;
            --text-main: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --white: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; padding: 30px; }
        .page-container { max-width: 1200px; margin: 0 auto; animation: fadeIn 0.5s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dropdown & Header */
        .header-card { background: var(--white); padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .form-select-modern { width: 100%; height: 50px; padding: 0 15px; border-radius: 12px; border: 2px solid var(--border); font-weight: 700; color: var(--text-main); outline: none; transition: 0.3s; appearance: none; background: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path fill="gray" d="M7 7l3-3 3 3m0 6l-3 3-3-3"/></svg>') no-repeat right 15px center; background-size: 15px; }
        .form-select-modern:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-box { background: var(--white); padding: 25px; border-radius: 20px; border: 1px solid var(--border); text-align: center; position: relative; overflow: hidden; }
        .stat-box::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .stat-blue::before { background: var(--primary); }
        .stat-green::before { background: var(--success); }
        .stat-orange::before { background: var(--warning); }
        
        .stat-label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--muted); margin: 0; }
        .stat-value { font-size: 32px; font-weight: 900; color: var(--text-main); margin: 10px 0 0 0; }

        /* Dashboard Content */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; }
        .glass-card { background: var(--white); border-radius: 20px; border: 1px solid var(--border); padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        /* Skill Bars */
        .skill-item { margin-bottom: 20px; }
        .skill-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 800; font-size: 14px; color: var(--text-main); }
        .progress-bg { background: #f1f5f9; height: 12px; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; border-radius: 10px; transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* Table History */
        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th { text-align: left; padding: 15px; font-size: 11px; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .modern-table td { padding: 15px; border-bottom: 1px solid #f8fafc; font-size: 14px; }
        .score-pill { background: #dcfce7; color: #15803d; padding: 4px 10px; border-radius: 8px; font-weight: 800; font-size: 12px; }

        .btn-refresh { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>

<div class="page-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h1 style="margin: 0; font-size: 28px; font-weight: 900; color: var(--text-main);">Theo d√µi Ti·∫øn ƒë·ªô</h1>
            <p style="margin: 5px 0 0 0; color: var(--muted); font-size: 14px;">Ph√¢n t√≠ch k·ªπ nƒÉng c·ªßa h·ªçc vi√™n b·∫°n ƒëang ph·ª• tr√°ch.</p>
        </div>
        <button class="btn-refresh" onclick="init_progress()">
            <i class="fa-solid fa-rotate"></i> L√†m m·ªõi danh s√°ch
        </button>
    </div>

    <div class="header-card">
        <label style="display: block; margin-bottom: 12px; font-weight: 800; color: var(--text-main);">H·ªçc vi√™n b·∫°n ƒëang ph·ª• tr√°ch:</label>
        <select id="prog-student-select" class="form-select-modern" onchange="loadLearnerStats(this.value)">
            <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
        </select>
    </div>

    <div id="progress-container" style="display: none;">
        <div class="stats-grid">
            <div class="stat-box stat-blue">
                <p class="stat-label">ƒêi·ªÉm Trung B√¨nh</p>
                <h3 id="p-score" class="stat-value" style="color: var(--primary);">--</h3>
            </div>
            <div class="stat-box stat-green">
                <p class="stat-label">B√†i ho√†n th√†nh</p>
                <h3 id="p-completed" class="stat-value" style="color: var(--success);">--/30</h3>
            </div>
            <div class="stat-box stat-orange">
                <p class="stat-label">Ng√†y h·ªçc cu·ªëi</p>
                <h3 id="p-active" class="stat-value" style="color: var(--warning); font-size: 18px;">--</h3>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="glass-card">
                <h3 style="margin: 0 0 25px 0; font-size: 18px; font-weight: 800;">üìä Ph√¢n t√≠ch K·ªπ nƒÉng</h3>
                <div class="skill-item">
                    <div class="skill-info"><span>Speaking</span><span id="v-speaking">0%</span></div>
                    <div class="progress-bg"><div id="b-speaking" class="progress-fill" style="background: var(--primary);"></div></div>
                </div>
                <div class="skill-item">
                    <div class="skill-info"><span>Listening</span><span id="v-listening">0%</span></div>
                    <div class="progress-bg"><div id="b-listening" class="progress-fill" style="background: var(--success);"></div></div>
                </div>
                <div class="skill-item">
                    <div class="skill-info"><span>Vocabulary</span><span id="v-vocabulary">0%</span></div>
                    <div class="progress-bg"><div id="b-vocabulary" class="progress-fill" style="background: var(--warning);"></div></div>
                </div>
            </div>

            <div class="glass-card" style="padding: 0;">
                <div style="padding: 20px 25px; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 800;">üïí L·ªãch s·ª≠ b√†i n·ªôp</h3>
                </div>
                <div style="max-height: 350px; overflow-y: auto;">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Ng√†y</th>
                                <th>Ch·ªß ƒë·ªÅ</th>
                                <th style="text-align: right;">ƒêi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody id="p-history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');

    // 1. KH·ªûI T·∫†O: Ch·ªâ l·∫•y h·ªçc vi√™n thu·ªôc quy·ªÅn qu·∫£n l√Ω c·ªßa Mentor n√†y
    window.init_progress = async function() {
        const select = document.getElementById('prog-student-select');
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const myMentorId = userInfo.id || userInfo.user_id;

        if (!myMentorId) {
            select.innerHTML = '<option value="">‚ö†Ô∏è L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c Mentor</option>';
            return;
        }

        try {
            // G·ªçi API l·ªçc t·∫°i ngu·ªìn
            const res = await fetch('/api/mentors/learners-list?mentor_id=' + myMentorId, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const learners = await res.json();
            
            if (!learners || learners.length === 0) {
                select.innerHTML = '<option value="">-- Ch∆∞a c√≥ h·ªçc vi√™n n√†o trong danh s√°ch --</option>';
                return;
            }
            
            // S·ª¨A L·ªñI HI·ªÇN TH·ªä T·∫†I ƒê√ÇY: D√πng ph√©p n·ªëi chu·ªói c·ªï ƒëi·ªÉn
            select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n c·ªßa b·∫°n (' + learners.length + ') --</option>';
            
            learners.forEach(function(l) {
                var name = l.full_name || l.username || 'H·ªçc vi√™n';
                select.innerHTML += '<option value="' + l.id + '">' + name + ' (' + l.email + ')</option>';
            });
        } catch(e) { 
            console.error(e);
            select.innerHTML = '<option value="">‚ö†Ô∏è L·ªói k·∫øt n·ªëi m√°y ch·ªß 5002</option>'; 
        }
    };

    // 2. N·∫†P CHI TI·∫æT
    window.loadLearnerStats = async function(learnerId) {
        if(!learnerId) { document.getElementById('progress-container').style.display = 'none'; return; }

        try {
            const res = await fetch('/api/analytics/learner/' + learnerId, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            document.getElementById('progress-container').style.display = 'block';
            
            document.getElementById('p-score').innerText = data.average_score || '0.0';
            document.getElementById('p-completed').innerText = (data.completed_lessons || 0) + '/30';
            document.getElementById('p-active').innerText = data.last_active || 'Ch∆∞a h·ªçc';

            setTimeout(function() {
                var s = data.skills || { speaking: 0, listening: 0, vocabulary: 0 };
                document.getElementById('b-speaking').style.width = (s.speaking || 0) + '%';
                document.getElementById('v-speaking').innerText = (s.speaking || 0) + '%';
                document.getElementById('b-listening').style.width = (s.listening || 0) + '%';
                document.getElementById('v-listening').innerText = (s.listening || 0) + '%';
                document.getElementById('b-vocabulary').style.width = (s.vocabulary || 0) + '%';
                document.getElementById('v-vocabulary').innerText = (s.vocabulary || 0) + '%';
            }, 100);

            const tbody = document.getElementById('p-history-body');
            if (data.recent_history && data.recent_history.length > 0) {
                tbody.innerHTML = data.recent_history.map(function(h) {
                    return '<tr>' +
                        '<td style="color: #64748b;">' + h.date + '</td>' +
                        '<td style="font-weight: 700; color: #1e293b;">' + h.lesson + '</td>' +
                        '<td style="text-align: right;"><span class="score-pill">' + h.score + ' pts</span></td>' +
                        '</tr>';
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:#94a3b8;">H·ªçc vi√™n n√†y ch∆∞a c√≥ b√†i n·ªôp n√†o.</td></tr>';
            }
        } catch(e) { alert("‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu ph√¢n t√≠ch."); }
    };

    init_progress();
</script>
</body>
</html>