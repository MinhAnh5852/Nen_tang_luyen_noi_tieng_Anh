<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/submissions.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body, html { height: auto; overflow-y: auto; background: #f8fafc; }
    .page-container { padding: 30px; max-width: 1200px; margin: 0 auto; }
    
    .learner-group-card {
        background: white; border-radius: 20px; border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 30px;
        overflow: hidden; transition: 0.3s;
    }
    .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
    .status-graded { background: #dcfce7; color: #15803d; }
    .status-waiting { background: #fef3c7; color: #92400e; }
</style>

<div class="page-container">
    <div class="page-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <div>
            <h1 style="font-size: 24px; font-weight: 900; color: #1e293b;">Ch·∫•m ƒêi·ªÉm B√†i N√≥i</h1>
            <p style="color: #64748b; font-size: 14px;">Xem transcript v√† nghe √¢m thanh ƒë·ªÉ ƒë√°nh gi√° h·ªçc vi√™n.</p>
        </div>
        <button class="btn btn-primary" onclick="init_submissions()">
            <i class="fa-solid fa-sync"></i> L√†m m·ªõi
        </button>
    </div>

    <div id="submissions-list">
        </div>
</div>

<script>
    const token = localStorage.getItem('token');
    const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
    const mentorId = userInfo.id || userInfo.user_id;

    let currentSubmissionsData = [];

    window.init_submissions = async function() {
        const container = document.getElementById('submissions-list');
        try {
            const res = await fetch(`/api/ai/submissions/for-mentor/${mentorId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const rawData = await res.json();
            currentSubmissionsData = rawData;

            if (!rawData || rawData.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:50px;">üì≠ Ch∆∞a c√≥ b√†i n·ªôp n√†o.</div>`;
                return;
            }

            const groupedData = rawData.reduce((groups, item, index) => {
                const name = item.username || 'H·ªçc vi√™n';
                if (!groups[name]) groups[name] = [];
                item.originalIndex = index;
                groups[name].push(item);
                return groups;
            }, {});

            let html = '';
            for (const [learnerName, submissions] of Object.entries(groupedData)) {
                html += `
                <div class="learner-group-card">
                    <div class="learner-header" style="padding:15px 25px; background:#f8fafc; display:flex; justify-content:space-between; border-bottom:1px solid #eee;">
                        <strong style="font-size:16px;">${learnerName}</strong>
                        <span>${submissions.length} b√†i t·∫≠p</span>
                    </div>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#fcfcfd; font-size:12px; color:#94a3b8; text-transform:uppercase;">
                                <th style="padding:12px 25px; text-align:left;">Ch·ªß ƒë·ªÅ</th>
                                <th style="padding:12px 25px; text-align:left;">Tr·∫°ng th√°i</th>
                                <th style="padding:12px 25px; text-align:right;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${submissions.map(s => {
                                const isGraded = s.mentor_feedback !== null && s.status === 'Graded';
                                return `
                                <tr style="border-top:1px solid #f1f5f9;">
                                    <td style="padding:12px 25px;"><strong>${s.topic || 'H·ªôi tho·∫°i'}</strong></td>
                                    <td style="padding:12px 25px;">
                                        <span class="status-pill ${isGraded ? 'status-graded' : 'status-waiting'}">
                                            ${isGraded ? 'ƒê√£ ch·∫•m' : 'Ch·ªù ch·∫•m'}
                                        </span>
                                    </td>
                                    <td style="padding:12px 25px; text-align:right;">
                                        <button class="btn-action-sm" onclick="openGradingModal(${s.originalIndex})" style="background:#2563eb; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">
                                            Ch·∫•m ngay
                                        </button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
            }
            container.innerHTML = html;
        } catch(e) { container.innerHTML = "L·ªói n·∫°p d·ªØ li·ªáu."; }
    };

    window.openGradingModal = function(index) {
        const data = currentSubmissionsData[index];
        const parentDoc = window.parent.document;
        
        // G√°n Transcript (ƒê√¢y l√† ph·∫ßn b·∫°n ch∆∞a th·∫•y n√∫t xem - n√≥ s·∫Ω hi·ªán ngay trong Modal)
        const transcriptDisplay = parentDoc.getElementById('display-transcript');
        if (transcriptDisplay) {
            // Hi·ªÉn th·ªã AI feedback ho·∫∑c n·ªôi dung b√†i h·ªçc vi√™n
            transcriptDisplay.innerText = data.ai_feedback || data.transcript || "Kh√¥ng c√≥ n·ªôi dung vƒÉn b·∫£n.";
        }

        // G√°n Audio
        const audioPlayer = parentDoc.getElementById('audio-player');
        if (audioPlayer) {
            audioPlayer.src = data.audio_url || "";
            audioPlayer.load();
        }
        
        // L∆∞u ID cho trang cha
        window.parent.currentSubmissionId = data.id;
        window.parent.currentLearnerId = data.user_id;
        window.parent.currentTopic = data.topic;
        
        // G·ªçi l·ªánh m·ªü Modal ·ªü trang cha
        window.parent.openModal('gradingModal');
    };

    init_submissions();
</script>