<link rel="stylesheet" href="css/submissions.css">

<div class="page-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
    <div>
        <h1 class="page-title">Ch·∫•m ƒêi·ªÉm B√†i N√≥i</h1>
        <p style="color: var(--muted); font-size: 13px; margin-top: 4px;">ƒê√°nh gi√° chi ti·∫øt c√°c b√†i th·ª±c h√†nh h·ªôi tho·∫°i AI c·ªßa h·ªçc vi√™n.</p>
    </div>
    <button class="btn btn-primary" onclick="init_submissions()">
        <i class="fa-solid fa-sync"></i> L√†m m·ªõi danh s√°ch
    </button>
</div>

<div class="table-card">
    <table class="data-table">
        <thead>
            <tr>
                <th>H·ªçc vi√™n</th>
                <th>Ch·ªß ƒë·ªÅ b√†i t·∫≠p</th>
                <th>Ng√†y n·ªôp</th>
                <th>Tr·∫°ng th√°i</th>
                <th style="text-align:right">H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="sub-tbody">
            <tr><td colspan="5" style="text-align:center; padding:40px; color: var(--muted);">
                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i danh s√°ch b√†i n·ªôp...
            </td></tr>
        </tbody>
    </table>
</div>

<script>
    // 1. H√†m kh·ªüi t·∫°o n·∫°p d·ªØ li·ªáu b√†i n·ªôp
    window.init_submissions = async function() {
        const tbody = document.getElementById('sub-tbody');
        const token = localStorage.getItem('token');

        try {
            // Gi·∫£ l·∫≠p l·∫•y d·ªØ li·ªáu t·ª´ endpoint n·ªôp b√†i c·ªßa h·ªçc vi√™n
            const res = await fetch('/api/ai/history/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">üì≠ Hi·ªán ch∆∞a c√≥ b√†i t·∫≠p n√†o c·∫ßn ch·∫•m.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(s => {
                // X√°c ƒë·ªãnh badge tr·∫°ng th√°i
                const isGraded = s.mentor_feedback !== undefined;
                const statusBadge = isGraded 
                    ? '<span class="status-badge status-active">ƒê√£ ch·∫•m</span>' 
                    : '<span class="status-badge status-pending">Ch·ªù ch·∫•m</span>';

                return `
                <tr>
                    <td>
                        <div class="user-info">
                            <div class="avatar-circle avatar-orange" style="width:32px; height:32px; border-radius:10px; font-size:12px;">
                                ${(s.username || 'H').substring(0,1).toUpperCase()}
                            </div>
                            <div class="user-text">
                                <h4 style="margin:0; font-size:13px;">${s.username || 'H·ªçc vi√™n'}</h4>
                            </div>
                        </div>
                    </td>
                    <td><strong style="color:var(--text-main); font-size:13px;">${s.topic || 'H·ªôi tho·∫°i t·ª± do'}</strong></td>
                    <td style="color:var(--text-light); font-size:12px;">${s.date || 'V·ª´a xong'}</td>
                    <td>${statusBadge}</td>
                    <td style="text-align:right">
                        <button class="btn-grade-action" onclick="openGradingModal('${s.id}', '${s.audio_url || ''}', '${s.text || ''}')">
                            <i class="fa-solid fa-pen-nib"></i> ${isGraded ? 'S·ª≠a ƒëi·ªÉm' : 'Ch·∫•m ngay'}
                        </button>
                    </td>
                </tr>`;
            }).join('');
        } catch(e) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red; padding:20px;">‚ö†Ô∏è L·ªói k·∫øt n·ªëi h·ªá th·ªëng b√†i t·∫≠p.</td></tr>';
        }
    };

    // 2. M·ªü Modal ch·∫•m ƒëi·ªÉm t·ª´ trang cha v√† truy·ªÅn d·ªØ li·ªáu
    window.openGradingModal = function(id, audioUrl, transcript) {
        // G·∫Øn th√¥ng tin b√†i n·ªôp v√†o Modal trong mentor.html
        const modal = window.parent.document.getElementById('gradingModal');
        const audio = window.parent.document.getElementById('audio-player');
        
        if (audioUrl) audio.src = audioUrl;
        
        // L∆∞u ID hi·ªán t·∫°i ƒë·ªÉ submit
        window.parent.currentSubmissionId = id;
        
        window.parent.openModal('gradingModal');
    };

    // T·ª± ƒë·ªông ch·∫°y khi n·∫°p trang
    init_submissions();
</script>