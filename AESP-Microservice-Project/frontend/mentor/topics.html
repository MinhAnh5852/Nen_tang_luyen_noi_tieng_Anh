<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/topics.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="page-container">
    <div class="page-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <div>
            <h1 class="page-title">Th∆∞ Vi·ªán Ch·ªß ƒê·ªÅ H·ªôi Tho·∫°i</h1>
            <p style="color: var(--muted); font-size: 13px; margin-top: 4px;">Qu·∫£n l√Ω c√°c t√¨nh hu·ªëng th·ª±c t·∫ø cho h·ªá th·ªëng luy·ªán t·∫≠p AI.</p>
        </div>
        <button class="btn btn-primary" onclick="openTopicModal()">
            <i class="fa-solid fa-plus"></i> Th√™m ch·ªß ƒë·ªÅ m·ªõi
        </button>
    </div>

    <div id="topics-grid" class="topics-grid-container">
        <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--muted);">
            <i class="fas fa-spinner fa-spin"></i> ƒêang n·∫°p danh s√°ch ch·ªß ƒë·ªÅ...
        </div>
    </div>
</div>

<div class="modal-backdrop" id="topicModal">
    <div class="modal" style="max-width: 550px;">
        <div class="modal-hd" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px;">
            <h3 style="margin:0;"><i class="fa-solid fa-comments"></i> Th√™m ch·ªß ƒë·ªÅ m·ªõi</h3>
            <i class="fa-solid fa-xmark" onclick="closeTopicModal()" style="cursor:pointer; font-size: 20px; color: #999;"></i>
        </div>
        <div class="modal-bd" style="padding-top: 20px;">
            <div class="form-row" style="margin-bottom: 15px;">
                <label style="font-weight: 700;">T√™n ch·ªß ƒë·ªÅ (Ti·∫øng Anh):</label>
                <input type="text" id="topic-name" class="form-control" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="VD: Job Interview at Tech Company">
            </div>
            <div class="form-row" style="margin-bottom: 15px;">
                <label style="font-weight: 700;">Nh√≥m lƒ©nh v·ª±c (Level):</label>
                <select id="topic-category" class="form-control" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                    <option value="Work">C√¥ng vi·ªác (Work)</option>
                    <option value="Travel">Du l·ªãch (Travel)</option>
                    <option value="Daily Life">ƒê·ªùi s·ªëng (Daily Life)</option>
                    <option value="Health">Y t·∫ø & S·ª©c kh·ªèe (Health)</option>
                </select>
            </div>
            <div class="form-row" style="margin-bottom: 15px;">
                <label style="font-weight: 700;">M√¥ t·∫£ t√¨nh hu·ªëng:</label>
                <textarea id="topic-desc" class="form-control" rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="M√¥ t·∫£ b·ªëi c·∫£nh chi ti·∫øt ƒë·ªÉ AI nh·∫≠p vai..."></textarea>
            </div>
        </div>
        <div class="modal-ft" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button class="btn btn-outline" onclick="closeTopicModal()">H·ªßy</button>
            <button id="btn-save-topic" class="btn btn-primary" onclick="handleCreateTopic()">L∆∞u ch·ªß ƒë·ªÅ</button>
        </div>
    </div>
</div>

<script>
    // ‚úÖ G·ªçi tr·ª±c ti·∫øp c·ªïng 5002
    const SERVICE_URL = 'http://localhost:5002/api/mentors'; 
    const token = localStorage.getItem('token');

    function openTopicModal() { document.getElementById('topicModal').classList.add('show'); }
    function closeTopicModal() { document.getElementById('topicModal').classList.remove('show'); }

    // --- üü¢ H√ÄM V·∫º GIAO DI·ªÜN (Quan tr·ªçng: S·ª≠a l·ªói defined) ---
    function renderTopics(data) {
        const grid = document.getElementById('topics-grid');
        if (!data || data.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: var(--muted);">üì≠ Th∆∞ vi·ªán hi·ªán ƒëang tr·ªëng.</div>';
            return;
        }

        grid.innerHTML = data.map(t => {
            let icon = 'fa-briefcase';
            if(t.level === 'Travel') icon = 'fa-plane-departure';
            if(t.level === 'Daily Life') icon = 'fa-house-user';
            if(t.level === 'Health') icon = 'fa-heart-pulse';

            return `
            <div class="topic-item-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 40px; height: 40px; background: #f0f7ff; color: #007bff; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid ${icon}"></i>
                    </div>
                    <span style="font-size: 12px; font-weight: 700; color: #007bff; background: #e6f0ff; padding: 4px 8px; border-radius: 4px;">${t.level || 'Work'}</span>
                </div>
                <div class="topic-body-info">
                    <h4 style="margin: 0 0 8px 0; color: #333;">${t.topic_name}</h4>
                    <p style="font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 15px;">${t.description || 'Ch∆∞a c√≥ m√¥ t·∫£.'}</p>
                </div>
                <div style="display: flex; justify-content: flex-end;">
                    <button onclick="deleteTopic('${t.id}')" style="color: #ff4d4f; border: none; background: none; cursor: pointer; font-size: 16px;">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    // 1. L·∫•y danh s√°ch
    window.init_topics = async function() {
        const grid = document.getElementById('topics-grid');
        try {
            const res = await fetch(`${SERVICE_URL}/topics`, { 
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
            
            if (!res.ok) throw new Error(`L·ªói Service: ${res.status}`);
            const data = await res.json();
            renderTopics(data); // ƒê√£ c√≥ h√†m ·ªü tr√™n, h·∫øt l·ªói r·ªìi B·∫£o nh√©!

        } catch(e) {
            console.error("L·ªói:", e);
            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red; padding:40px;">‚ö†Ô∏è L·ªói: ${e.message}</div>`;
        }
    };

    // 2. Th√™m m·ªõi
    async function handleCreateTopic() {
        const btn = document.getElementById('btn-save-topic');
        const payload = {
            topic_name: document.getElementById('topic-name').value,
            level: document.getElementById('topic-category').value,
            description: document.getElementById('topic-desc').value
        };

        if(!payload.topic_name || !payload.description) return alert("B·∫£o ∆°i ƒëi·ªÅn ƒë·ªß th√¥ng tin gi√∫p m√¨nh nh√©!");

        btn.disabled = true;
        btn.innerHTML = 'ƒêang l∆∞u...';

        try {
            const res = await fetch(`${SERVICE_URL}/topics`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("‚úÖ Th√™m ch·ªß ƒë·ªÅ th√†nh c√¥ng!");
                closeTopicModal();
                init_topics(); 
                document.getElementById('topic-name').value = '';
                document.getElementById('topic-desc').value = '';
            } else {
                alert("‚ùå L·ªói: " + res.status);
            }
        } catch (e) {
            alert("‚ùå L·ªói k·∫øt n·ªëi c·ªïng 5002.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'L∆∞u ch·ªß ƒë·ªÅ';
        }
    }

    // 3. X√≥a ch·ªß ƒë·ªÅ
    async function deleteTopic(id) {
        if(!confirm("B·∫£o c√≥ ch·∫Øc mu·ªën x√≥a ch·ªß ƒë·ªÅ n√†y kh√¥ng?")) return;
        try {
            const res = await fetch(`${SERVICE_URL}/topics/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) init_topics();
        } catch(e) { console.error(e); }
    }

    init_topics();
</script>