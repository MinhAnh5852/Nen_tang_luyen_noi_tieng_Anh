<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mentor Dashboard ‚Ä¢ AESP</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/main.css">

    <style>
        /* CSS C∆† B·∫¢N */
        .btn, button, .btn-sm, .btn-primary, .btn-outline { 
            border-radius: 12px !important; 
            padding: 12px 32px !important; 
            font-weight: 700 !important;
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s ease; 
            cursor: pointer; 
            border: none;
        }
        .content-card, .mini-card, .alert-card, .sidebar, .topbar, .dd-menu, .modal { 
            border-radius: 16px !important; 
        }
        .sb-link { 
            border-radius: 12px !important; 
            margin: 6px 12px !important; 
            padding: 12px 16px !important; 
        }
        input, select, textarea { 
            border-radius: 10px !important; 
            padding: 10px !important; 
            border: 1px solid #d1d5db; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(0,0,0,0.15); 
            filter: brightness(1.1); 
        }
        /* DARK MODE STYLES */
        body.dark-mode { background-color: #111827; color: #f3f4f6; }
        body.dark-mode .sidebar { background-color: #1f2937; color: #fff; }
        body.dark-mode .content-card, body.dark-mode .topbar, body.dark-mode .modal-content, body.dark-mode .mentor-info-area { 
            background-color: #1f2937; color: #f3f4f6; border-color: #374151; 
        }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4 { color: #f9fafb !important; }
        body.dark-mode .sb-link:hover, body.dark-mode .sb-link.active { background-color: #374151; }
        
        /* CSS MENTOR TEST AREA */
        .mentor-info-area { 
            background-color: #fff; 
            border: 1px solid #e2e8f0; 
            padding: 25px; 
            margin-bottom: 30px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-control { flex: 1; padding: 12px; font-size: 0.95rem; }
        
        .mentor-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .mentor-item { 
            background: #fff; 
            border: 1px solid #e2e8f0; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            transition: transform 0.2s; 
        }
        .mentor-item:hover { transform: translateY(-3px); border-color: #3b82f6; }
        .mentor-skill-tag { 
            background: #eff6ff; 
            color: #1d4ed8; 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: 600; 
            display: inline-block; 
            margin-right: 5px; 
            margin-bottom: 5px; 
        }

        /* CSS MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 9999;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content {
            background: white; width: 500px; max-width: 90%;
            border-radius: 20px; padding: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9); transition: transform 0.3s ease; position: relative;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .close-modal {
            position: absolute; top: 20px; right: 20px;
            background: #f1f5f9; border: none; width: 32px; height: 32px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: #64748b; transition: 0.2s;
        }
        .close-modal:hover { background: #e2e8f0; color: #ef4444; }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .modal-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px; display: block; border: 4px solid #f8fafc; }
    </style>
</head>

<body>
<div class="app">
    <aside class="sidebar">
        <div class="sb-brand">
            <div class="sb-logo"><i class="fa-solid fa-robot"></i></div>
            <div><h3>AESP</h3><p>Mentor</p></div>
        </div>
        <div class="sb-group-title">DASHBOARD</div>
        <a class="sb-link active" href="#" data-section="learners"><i class="fa-solid fa-user-group"></i> <span>H·ªçc vi√™n</span></a>
        
        <div class="sb-group-title">QU·∫¢N L√ù</div>
        <a class="sb-link" href="#" data-section="progress"><i class="fa-solid fa-chart-line"></i> <span>Ti·∫øn ƒë·ªô</span></a>
        <a class="sb-link" href="#" data-section="feedback"><i class="fa-regular fa-comment-dots"></i> <span>Ph·∫£n h·ªìi</span></a>
        <a class="sb-link" href="#" data-section="tasks"><i class="fa-solid fa-list-check"></i> <span>Giao b√†i</span></a>
        <a class="sb-link" href="#" data-section="ranking"><i class="fa-solid fa-ranking-star"></i> <span>X·∫øp h·∫°ng</span></a>
        
        <a class="sb-link" href="#" data-section="resources"><i class="fa-regular fa-folder-open"></i> <span>T√†i li·ªáu</span></a>
        <a class="sb-link" href="#" data-section="topics"><i class="fa-regular fa-comments"></i> <span>Ch·ªß ƒë·ªÅ</span></a>
        <a class="sb-link" href="#" data-section="submissions"><i class="fa-regular fa-file-lines"></i> <span>B√†i n·ªôp</span></a>
        
        <a class="sb-link" href="#" data-section="settings"><i class="fa-solid fa-gear"></i> <span>C√†i ƒë·∫∑t</span></a>
    </aside>

    <div class="main">
        <div class="topbar">
            <div class="topbar-inner">
                <h1 class="topbar-title" id="pageTitle">Mentor Dashboard</h1>
                <div class="topbar-right">
                    <button class="btn btn-primary btn-sm" onclick="openProfileModal()">H·ªì S∆° Mentor ‚ñº</button>
                </div>
            </div>
        </div>

        <main class="container">
            <div class="content-card alert-card" style="margin-bottom: 20px; border-left: 5px solid var(--primary-color);">
                <strong>Th√¥ng b√°o:</strong> H·ªá th·ªëng Mentor ƒë√£ s·∫µn s√†ng l√†m vi·ªác.
            </div>
            
            <div class="mentor-info-area">
                <h3 style="margin-top:0; margin-bottom: 20px; color: #1e293b; font-size: 1.25rem;">
                    <i class="fa-solid fa-user-pen" style="color: var(--primary-color); margin-right: 8px;"></i> 
                    ƒêi·ªÅn th√¥ng tin c·ªßa Mentor
                </h3>
                <div style="margin-bottom: 30px;">
                    <div class="form-row">
                        <input type="text" id="new-name" class="form-control" placeholder="H·ªç t√™n Mentor (V√≠ d·ª•: Nguy·ªÖn VƒÉn A)">
                        <input type="text" id="new-skills" class="form-control" placeholder="K·ªπ nƒÉng">
                    </div>
                    <div class="form-row">
                        <input type="text" id="new-bio" class="form-control" placeholder="Gi·ªõi thi·ªáu" style="flex: 3;">
                        <button class="btn btn-primary" onclick="registerMentorTest()" style="flex: 1; background: #2563eb;">
                            <i class="fa-solid fa-check-circle" style="margin-right: 8px;"></i> X√°c nh·∫≠n
                        </button>
                    </div>
                </div>
                <div style="border-top: 1px solid #e2e8f0; margin: 20px 0;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; font-weight: bold; color: #334155;">Danh s√°ch Mentor hi·ªán c√≥</h4>
                    <button class="btn btn-outline" style="background:#fff; border:1px solid #ccc; color:#333; padding: 8px 16px !important; font-size: 0.9rem;" onclick="loadMentorsFromAPI()">
                        <i class="fa-solid fa-rotate"></i> T·∫£i l·∫°i
                    </button>
                </div>
                <div id="api-mentor-list" class="mentor-grid">
                    <p style="color: #64748b; font-style: italic;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
            
            <div id="sectionHost"></div>
        </main>
    </div>
</div>

<div class="modal-overlay" id="learnerModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeLearnerModal()"><i class="fa-solid fa-xmark"></i></button>
        <img src="" id="m-avatar" class="modal-avatar">
        <h2 id="m-name" style="text-align: center; margin: 0 0 5px 0; color: #1e293b;"></h2>
        <p id="m-email" style="text-align: center; color: #64748b; margin-bottom: 25px; font-size: 0.9rem;"></p>
        <div class="detail-row"><span style="color:#64748b">ID H·ªçc vi√™n</span><span style="font-weight:600" id="m-id"></span></div>
        <div class="detail-row"><span style="color:#64748b">Tr√¨nh ƒë·ªô</span><span style="font-weight:600" id="m-level"></span></div>
        <div class="detail-row"><span style="color:#64748b">Tr·∫°ng th√°i</span><span style="font-weight:600" id="m-status"></span></div>
        <div class="detail-row"><span style="color:#64748b">Tham gia ng√†y</span><span style="color: #64748b; font-weight: normal;">28/01/2026</span></div>
        <div style="margin-top: 25px; display: flex;">
            <button class="btn btn-outline" style="width: 100%; border: 1px solid #ddd;" onclick="closeLearnerModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="taskModal">
    <div class="modal-content" style="width: 600px;">
        <button class="close-modal" onclick="closeTaskModal()"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin-top:0; color:#1e293b;">üìã Giao B√†i T·∫≠p M·ªõi</h3>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">H·ªçc vi√™n nh·∫≠n b√†i:</label>
            <select id="task-learner" class="form-control" style="width:100%; padding:12px;">
                <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
            </select>
        </div>
        <div style="margin-bottom: 15px;"><label style="display:block; margin-bottom:5px; font-weight:600;">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label><input type="text" id="task-title" class="form-control" style="width:100%;" placeholder="V√≠ d·ª•: Luy·ªán n√≥i ch·ªß ƒë·ªÅ Family"></div>
        <div style="margin-bottom: 15px;"><label style="display:block; margin-bottom:5px; font-weight:600;">H·∫°n n·ªôp (Deadline):</label><input type="date" id="task-deadline" class="form-control" style="width:100%;"></div>
        <div style="margin-bottom: 20px;"><label style="display:block; margin-bottom:5px; font-weight:600;">N·ªôi dung/Y√™u c·∫ßu:</label><textarea id="task-desc" class="form-control" rows="4" style="width:100%;" placeholder="Nh·∫≠p h∆∞·ªõng d·∫´n chi ti·∫øt..."></textarea></div>
        <button class="btn btn-primary" style="width:100%;" onclick="submitTask()"><i class="fa-solid fa-paper-plane"></i> G·ª≠i B√†i T·∫≠p</button>
    </div>
</div>

<div class="modal-overlay" id="resourceModal">
    <div class="modal-content" style="width: 500px;">
        <button class="close-modal" onclick="closeResourceModal()"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin-top:0; color:#1e293b;">üìÇ Th√™m T√†i Li·ªáu M·ªõi</h3>
        <div style="margin-bottom: 15px;"><label style="display:block; margin-bottom:5px; font-weight:600;">T√™n t√†i li·ªáu:</label><input type="text" id="res-title" class="form-control" style="width:100%;"></div>
        <div style="margin-bottom: 15px;"><label style="display:block; margin-bottom:5px; font-weight:600;">Link (URL):</label><input type="text" id="res-link" class="form-control" style="width:100%;"></div>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">K·ªπ nƒÉng:</label>
            <select id="res-skill" class="form-control" style="width:100%;">
                <option value="Speaking">Speaking</option><option value="Listening">Listening</option><option value="Reading">Reading</option>
                <option value="Writing">Writing</option><option value="Vocabulary">Vocabulary</option><option value="Grammar">Grammar</option><option value="General">General</option>
            </select>
        </div>
        <div style="margin-bottom: 20px;"><label style="display:block; margin-bottom:5px; font-weight:600;">M√¥ t·∫£:</label><textarea id="res-desc" class="form-control" rows="3" style="width:100%;"></textarea></div>
        <button class="btn btn-primary" style="width:100%;" onclick="submitResource()"><i class="fa-solid fa-check"></i> L∆∞u T√†i Li·ªáu</button>
    </div>
</div>

<div class="modal-overlay" id="createTopicModal">
    <div class="modal-content" style="width: 500px;">
        <button class="close-modal" onclick="closeCreateTopicModal()"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin-top:0; color:#1e293b;">Th√™m Ch·ªß ƒê·ªÅ M·ªõi</h3>
        <div style="margin-bottom: 15px;"><label style="display:block; margin-bottom:5px; font-weight:600;">T√™n ch·ªß ƒë·ªÅ:</label><input type="text" id="new-topic-name" class="form-control" style="width:100%;"></div>
        <div style="margin-bottom: 15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Tr√¨nh ƒë·ªô:</label>
            <select id="new-topic-level" class="form-control" style="width:100%;">
                <option value="A1-A2">A1-A2 (Beginner)</option><option value="B1-B2">B1-B2 (Intermediate)</option><option value="C1-C2">C1-C2 (Advanced)</option>
            </select>
        </div>
        <div style="margin-bottom: 20px;"><label style="display:block; margin-bottom:5px; font-weight:600;">M√¥ t·∫£ / G·ª£i √Ω:</label><textarea id="new-topic-desc" class="form-control" rows="3" style="width:100%;"></textarea></div>
        <button class="btn btn-primary" style="width:100%;" onclick="submitNewTopic()"><i class="fa-solid fa-save"></i> L∆∞u v√†o th∆∞ vi·ªán</button>
    </div>
</div>

<div class="modal-overlay" id="gradingModal">
    <div class="modal-content" style="width: 500px;">
        <button class="close-modal" onclick="closeGradingModal()"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin-top:0; color:#1e293b;">‚úçÔ∏è Ch·∫•m ƒêi·ªÉm</h3>
        <div style="margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 12px; text-align: center;">
            <p style="margin:0 0 10px 0; font-weight:600; color:#334155;">Nghe b√†i l√†m:</p>
            <audio id="audio-player" controls style="width: 100%;"></audio>
        </div>
        <div style="margin-bottom: 15px;"><label style="display:block; margin-bottom:5px; font-weight:600;">ƒêi·ªÉm s·ªë (0 - 10):</label><input type="number" id="grade-score" class="form-control" style="width:100%;" min="0" max="10" step="0.5"></div>
        <div style="margin-bottom: 20px;"><label style="display:block; margin-bottom:5px; font-weight:600;">Nh·∫≠n x√©t:</label><textarea id="grade-feedback" class="form-control" rows="4" style="width:100%;"></textarea></div>
        <input type="hidden" id="current-submission-id">
        <button class="btn btn-primary" style="width:100%;" onclick="submitGrade()"><i class="fa-solid fa-check-circle"></i> Ho√†n T·∫•t Ch·∫•m ƒêi·ªÉm</button>
    </div>
</div>

<div class="modal-overlay" id="profileModal">
    <div class="modal-content" style="width: 500px;">
        <button class="close-modal" onclick="closeProfileModal()"><i class="fa-solid fa-xmark"></i></button>
        <h3 style="margin-top:0; color:#1e293b; text-align:center;">H·ªì S∆° Mentor</h3>
        <div style="text-align:center; margin-bottom:20px;">
            <div style="width:100px; height:100px; background:#e2e8f0; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:40px; color:#64748b;"><i class="fa-solid fa-user"></i></div>
            <p style="color:#64748b; font-size:0.9rem;">ID: <span id="my-profile-id"></span></p>
        </div>
        <div style="margin-bottom: 15px;"><label style="font-weight:600;">H·ªç t√™n hi·ªÉn th·ªã:</label><input type="text" id="my-profile-name" class="form-control" style="width:100%;"></div>
        <div style="margin-bottom: 15px;"><label style="font-weight:600;">Email li√™n h·ªá:</label><input type="text" id="my-profile-email" class="form-control" style="width:100%;" readonly style="background:#f1f5f9;"></div>
        <div style="margin-bottom: 15px;"><label style="font-weight:600;">K·ªπ nƒÉng (c√°ch nhau d·∫•u ph·∫©y):</label><input type="text" id="my-profile-skills" class="form-control" style="width:100%;" placeholder="IELTS, TOEIC, Speaking..."></div>
        <div style="margin-bottom: 25px;"><label style="font-weight:600;">Gi·ªõi thi·ªáu b·∫£n th√¢n:</label><textarea id="my-profile-bio" class="form-control" rows="3" style="width:100%;"></textarea></div>
        <button class="btn btn-primary" style="width:100%; margin-bottom: 10px;" onclick="updateMyProfile()"><i class="fa-solid fa-floppy-disk"></i> L∆∞u thay ƒë·ªïi</button>
        <button class="btn btn-outline" style="width:100%; border:1px solid #fee2e2; background:#fef2f2; color:#dc2626;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t</button>
    </div>
</div>

<script>
    // --- L·∫§Y ID TH·∫¨T T·ª™ STORAGE (S·ª≠a logic l·∫•y ID) ---
    // T√¨m trong localStorage, sessionStorage, n·∫øu kh√¥ng c√≥ th√¨ m·ªõi d√πng current_mentor
    const storedUser = localStorage.getItem('user_id') || sessionStorage.getItem('user_id') || 'current_mentor';
    window.CURRENT_MENTOR_ID = storedUser;
    
    // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p (ID l√† current_mentor), c·∫£nh b√°o ngay
    if(window.CURRENT_MENTOR_ID === 'current_mentor') {
        console.warn("‚ö†Ô∏è C·∫£nh b√°o: Ch∆∞a t√¨m th·∫•y User ID trong b·ªô nh·ªõ tr√¨nh duy·ªát.");
        // B·∫°n c√≥ th·ªÉ b·ªè comment d√≤ng d∆∞·ªõi n·∫øu mu·ªën b·∫Øt bu·ªôc ƒëƒÉng nh·∫≠p
        // alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! ƒêang d√πng ch·∫ø ƒë·ªô Test."); 
    } else {
        console.log("‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p v·ªõi ID:", window.CURRENT_MENTOR_ID);
    }

    window.LEARNERS_API_URL = 'http://127.0.0.1:5002/api/learners-list';
    
    document.addEventListener('DOMContentLoaded', () => {
        const sectionHost = document.getElementById('sectionHost');
        const sidebarLinks = document.querySelectorAll('.sb-link');
        const pageTitle = document.getElementById('pageTitle');
        const profileBtn = document.getElementById('profileBtn');
        const dropdown = document.getElementById('dropdown');

        async function loadSection(name) {
            sectionHost.innerHTML = '<div style="padding:20px; text-align:center;">ƒêang t·∫£i...</div>';
            try {
                if(name === 'settings') {
                    // C·∫¨P NH·∫¨T: ƒê√£ b·ªè ph·∫ßn ng√¥n ng·ªØ
                    sectionHost.innerHTML = `
                    <div class="content-card">
                        <h2 style="margin-top:0; color:#1e293b; margin-bottom: 5px;">C√†i ƒê·∫∑t</h2>
                        <p style="color:#64748b; margin-bottom: 25px;">Tu·ª≥ ch·ªânh giao di·ªán v√† nh·∫Øc nh·ªü.</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px;">
                                <h4 style="margin:0 0 10px 0; color:#334155;">ƒê·ªïi theme</h4>
                                <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">Ch·ªçn giao di·ªán s√°ng/t·ªëi cho Dashboard.</p>
                                <select id="set-theme" class="form-control" style="width:100%; margin-bottom:15px;"><option value="Light">Light (S√°ng)</option><option value="Dark">Dark (T·ªëi)</option></select>
                                <button class="btn btn-primary" style="width:100%;" onclick="saveSettings()">L∆∞u theme</button>
                            </div>
                            <div style="background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px;">
                                <h4 style="margin:0 0 10px 0; color:#334155;">B·∫≠t/t·∫Øt nh·∫Øc nh·ªü</h4>
                                <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">G·ª≠i email/th√¥ng b√°o khi h·ªçc vi√™n n·ªôp b√†i.</p>
                                <div style="margin-bottom:15px;"><input type="checkbox" id="set-remind-check"> <label for="set-remind-check">B·∫≠t nh·∫Øc nh·ªü</label></div>
                                <div style="margin-bottom:15px;"><label style="font-size:0.9rem;">Gi·ªù nh·∫Øc:</label><input type="time" id="set-remind-time" class="form-control" style="width:100%;"></div>
                                <button class="btn btn-primary" style="width:100%;" onclick="saveSettings()">L∆∞u nh·∫Øc nh·ªü</button>
                            </div>
                        </div>
                    </div>`;
                    pageTitle.innerText = 'C√†i ƒë·∫∑t h·ªá th·ªëng';
                    initSettingsPage();
                    return;
                }

                const res = await fetch(`./sections/${name}.html?t=` + Date.now());
                if(!res.ok) throw new Error("File kh√¥ng t·ªìn t·∫°i");
                sectionHost.innerHTML = await res.text();
                const titles = { 'learners': 'Danh s√°ch h·ªçc vi√™n', 'progress': 'Ti·∫øn ƒë·ªô h·ªçc t·∫≠p', 'feedback': 'Ph·∫£n h·ªìi h·ªçc vi√™n', 'tasks': 'Qu·∫£n l√Ω b√†i t·∫≠p', 'ranking': 'B·∫£ng X·∫øp H·∫°ng', 'resources': 'T√†i Li·ªáu H·ªó Tr·ª£', 'topics': 'Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ', 'submissions': 'B√†i N·ªôp C·ªßa H·ªçc Vi√™n' };
                pageTitle.innerText = titles[name] || 'Dashboard';
            } catch(e) { sectionHost.innerHTML = 'L·ªói: ' + e.message; }
        }

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                loadSection(link.getAttribute('data-section'));
            });
        });

        loadSection('learners');
        loadMentorsFromAPI();
        applySettings(); 
    });

    // 2. MODAL FUNCTIONS
    window.openLearnerModal = function(id) {
        const l = window.allLearnersData.find(x => x.id == id); if(!l) return;
        document.getElementById('m-name').innerText = l.full_name;
        document.getElementById('m-email').innerText = l.email;
        document.getElementById('m-id').innerText = l.id;
        document.getElementById('m-level').innerText = l.level;
        document.getElementById('m-status').innerText = l.status;
        document.getElementById('m-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(l.full_name)}&background=random&size=128`;
        const m = document.getElementById('learnerModal'); m.style.display = 'flex'; setTimeout(() => m.classList.add('show'), 10);
    }
    window.closeLearnerModal = function() { document.getElementById('learnerModal').style.display = 'none'; }
    window.openTaskModal = function() { const m = document.getElementById('taskModal'); m.style.display = 'flex'; setTimeout(()=>m.classList.add('show'), 10); }
    window.closeTaskModal = function() { document.getElementById('taskModal').style.display='none'; }
    window.openResourceModal = function() { const m = document.getElementById('resourceModal'); m.style.display = 'flex'; setTimeout(()=>m.classList.add('show'), 10); }
    window.closeResourceModal = function() { document.getElementById('resourceModal').style.display='none'; }
    window.openCreateTopicModal = function() { const m = document.getElementById('createTopicModal'); m.style.display = 'flex'; setTimeout(()=>m.classList.add('show'), 10); }
    window.closeCreateTopicModal = function() { document.getElementById('createTopicModal').style.display='none'; }
    window.openGradingModal = function(id, audio, score, feedback) {
        document.getElementById('current-submission-id').value = id;
        document.getElementById('audio-player').src = audio;
        document.getElementById('grade-score').value = score || '';
        document.getElementById('grade-feedback').value = feedback || '';
        const m = document.getElementById('gradingModal'); m.style.display = 'flex'; setTimeout(()=>m.classList.add('show'), 10);
    }
    window.closeGradingModal = function() { document.getElementById('gradingModal').style.display='none'; document.getElementById('audio-player').pause(); }

    window.openProfileModal = async function() {
        try {
            const res = await fetch(`http://127.0.0.1:5002/api/mentor-profile/${window.CURRENT_MENTOR_ID}`);
            const data = await res.json();
            document.getElementById('my-profile-id').innerText = window.CURRENT_MENTOR_ID;
            document.getElementById('my-profile-name').value = data.full_name;
            document.getElementById('my-profile-email').value = data.email;
            document.getElementById('my-profile-bio').value = data.bio;
            document.getElementById('my-profile-skills').value = Array.isArray(data.skills) ? data.skills.join(', ') : data.skills;
            const m = document.getElementById('profileModal'); m.style.display = 'flex'; setTimeout(()=>m.classList.add('show'), 10);
        } catch(e) { alert("L·ªói t·∫£i h·ªì s∆°: " + e.message); }
    }
    window.closeProfileModal = function() { document.getElementById('profileModal').style.display='none'; }
    window.updateMyProfile = async function() {
        const name = document.getElementById('my-profile-name').value;
        const bio = document.getElementById('my-profile-bio').value;
        const skills = document.getElementById('my-profile-skills').value;
        try {
            const res = await fetch('http://127.0.0.1:5002/api/mentor-profile', {
                method: 'PUT', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: window.CURRENT_MENTOR_ID, full_name: name, bio: bio, skills: skills })
            });
            if(res.ok) { alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆°!"); closeProfileModal(); } else { alert("L·ªói c·∫≠p nh·∫≠t"); }
        } catch(e) { alert("L·ªói k·∫øt n·ªëi"); }
    }
    window.logout = function() { 
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?")) { 
            localStorage.removeItem('user_id');
            sessionStorage.removeItem('user_id');
            // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
            // Gi·∫£ s·ª≠ file ƒëƒÉng nh·∫≠p t√™n l√† index.html ho·∫∑c login.html ·ªü th∆∞ m·ª•c cha
            window.location.href = '../login.html'; 
        } 
    }

    // 3. LOGIC FUNCTIONS
    window.loadLearnersFromDB = async function() {
        const tbody = document.getElementById('learner-table-body'); if(!tbody) return; tbody.innerHTML='';
        try {
            const res = await fetch(window.LEARNERS_API_URL + '?t=' + Date.now());
            const data = await res.json(); window.allLearnersData = data;
            data.forEach(l => {
                const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(l.full_name)}&background=random&size=32`;
                const badge = l.status === 'active' ? `<span style="background:#dcfce7; color:#166534; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:bold;">Active</span>` : `<span>${l.status}</span>`;
                tbody.innerHTML += `<tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding:15px; display:flex; gap:10px; align-items:center;"><img src="${avatar}" style="width:36px; height:36px; border-radius:50%"><div><div style="font-weight:600">${l.full_name}</div><div style="font-size:11px; color:#94a3b8">ID: ${l.id}</div></div></td><td style="padding:15px; color:#475569">${l.email}</td><td style="padding:15px"><span style="background:#dbeafe; color:#1e40af; padding:4px 8px; border-radius:4px; font-size:12px">${l.level}</span></td><td style="padding:15px">${badge}</td><td style="padding:15px"><button class="btn btn-sm btn-outline" style="padding:6px 12px; border:1px solid #ddd; background:white" onclick="openLearnerModal('${l.id}')">Chi ti·∫øt</button></td></tr>`;
            });
        } catch(e) {}
    }
    window.initProgressPage = async function() {
        const select = document.getElementById('prog-student-select'); if(!select) return;
        try { const res = await fetch(window.LEARNERS_API_URL); const data = await res.json(); select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>'; data.forEach(l => { select.innerHTML += `<option value="${l.id}">${l.full_name} (${l.email})</option>`; }); } catch(e) {}
    }
    window.loadLearnerStats = async function(learnerId) {
        if(!learnerId) { document.getElementById('progress-container').style.display='none'; return; }
        try {
            const res = await fetch(`http://127.0.0.1:5002/api/learner-progress/${learnerId}`); const data = await res.json();
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('p-score').innerText = data.average_score;
            document.getElementById('p-completed').innerText = `${data.completed_lessons}/${data.total_lessons}`;
            document.getElementById('p-active').innerText = data.last_active;
            document.getElementById('b-speaking').style.width = data.skills.speaking + '%'; 
            document.getElementById('b-listening').style.width = data.skills.listening + '%'; 
            document.getElementById('b-vocabulary').style.width = data.skills.vocabulary + '%'; 
            const tbody = document.getElementById('p-history-body'); tbody.innerHTML = '';
            data.recent_history.forEach(h => { tbody.innerHTML += `<tr><td style="padding:10px; border-bottom:1px solid #eee">${h.date}</td><td style="padding:10px; border-bottom:1px solid #eee">${h.lesson}</td><td style="padding:10px; border-bottom:1px solid #eee; font-weight:bold; color:#2563eb">${h.score}</td></tr>`; });
        } catch(e) { alert("L·ªói t·∫£i d·ªØ li·ªáu ti·∫øn ƒë·ªô"); }
    }
    window.initFeedbackPage = async function() {
        const select = document.getElementById('feedback-student-select'); if(!select) return;
        try { const res = await fetch(window.LEARNERS_API_URL); const data = await res.json(); select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>'; data.forEach(l => { select.innerHTML += `<option value="${l.id}">${l.full_name}</option>`; }); } catch(e) {}
    }
    window.loadFeedbackData = async function(learnerId) {
        const container = document.getElementById('feedback-list'); if(!learnerId) { container.innerHTML = '<p style="text-align:center; color:#999">Ch·ªçn h·ªçc vi√™n ƒë·ªÉ xem.</p>'; return; }
        try {
            const res = await fetch(`http://127.0.0.1:5002/api/learner-feedback/${learnerId}`); const data = await res.json();
            if(data.length === 0) { container.innerHTML = '<div class="alert-card">H·ªçc vi√™n n√†y ch∆∞a c√≥ ph·∫£n h·ªìi n√†o t·ª´ AI.</div>'; return; }
            container.innerHTML = '';
            data.forEach(item => {
                let color = '#3b82f6'; let bg = '#eff6ff'; let icon = '<i class="fa-solid fa-thumbs-up"></i>';
                if(item.sentiment === 'Neutral') { color = '#d97706'; bg = '#fffbeb'; icon = '<i class="fa-solid fa-scale-balanced"></i>'; }
                if(item.sentiment === 'Negative') { color = '#dc2626'; bg = '#fef2f2'; icon = '<i class="fa-solid fa-triangle-exclamation"></i>'; }
                container.innerHTML += `<div style="background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid ${color}; display: flex; gap: 15px;"><div style="background:${bg}; color:${color}; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">${icon}</div><div><div style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;">${item.date} ‚Ä¢ <strong>${item.sentiment}</strong></div><div style="color: #334155; line-height: 1.5;">${item.comment}</div></div></div>`;
            });
        } catch(e) {}
    }
    window.initTaskPage = async function() { await loadLearnersForTask(); await loadTasksFromDB(); }
    async function loadLearnersForTask() {
        const select = document.getElementById('task-learner'); if(!select) return;
        try { const res = await fetch(window.LEARNERS_API_URL); const data = await res.json(); select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>'; data.forEach(l => { select.innerHTML += `<option value="${l.id}" data-name="${l.full_name}">${l.full_name} (${l.email})</option>`; }); } catch(e) {}
    }
    async function loadTasksFromDB() {
        const container = document.getElementById('task-list-container'); if(!container) return;
        try {
            const res = await fetch('http://127.0.0.1:5002/api/tasks'); const tasks = await res.json();
            if(tasks.length === 0) { container.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8; background:#f8fafc; border-radius:12px;">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao.</div>`; return; }
            container.innerHTML = '';
            tasks.forEach(t => {
                const statusColor = t.status === 'Pending' ? '#d97706' : '#16a34a'; const statusBg = t.status === 'Pending' ? '#fffbeb' : '#dcfce7';
                container.innerHTML += `<div style="background:white; border:1px solid #e2e8f0; padding:20px; border-radius:12px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:bold; font-size:1.1rem; color:#334155; margin-bottom:5px;">${t.title}</div><div style="color:#64748b; font-size:0.9rem;"><i class="fa-solid fa-user"></i> ${t.learner_name} &nbsp;|&nbsp; <i class="fa-regular fa-clock"></i> Deadline: ${t.deadline}</div></div><span style="background:${statusBg}; color:${statusColor}; padding:6px 12px; border-radius:20px; font-weight:bold; font-size:0.85rem;">${t.status}</span></div>`;
            });
        } catch(e) {}
    }
    window.submitTask = async function() {
        const learnerSelect = document.getElementById('task-learner'); const learnerId = learnerSelect.value;
        const learnerName = learnerSelect.options[learnerSelect.selectedIndex].getAttribute('data-name');
        const title = document.getElementById('task-title').value; const deadline = document.getElementById('task-deadline').value; const desc = document.getElementById('task-desc').value;
        if(!learnerId || !title || !deadline) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!"); return; }
        try { const res = await fetch('http://127.0.0.1:5002/api/tasks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ learner_id: learnerId, learner_name: learnerName, title: title, description: desc, deadline: deadline }) }); if(res.ok) { alert("‚úÖ Giao b√†i th√†nh c√¥ng!"); closeTaskModal(); loadTasksFromDB(); } else { alert("‚ùå L·ªói khi giao b√†i"); } } catch(e) { alert("L·ªói: " + e.message); }
    }
    window.goToAssignTask = async function(learnerId) {
        document.querySelectorAll('.sb-link').forEach(l => l.classList.remove('active'));
        document.querySelector('[data-section="tasks"]').classList.add('active');
        const sectionHost = document.getElementById('sectionHost');
        sectionHost.innerHTML = '<div style="padding:20px; text-align:center;">ƒêang t·∫£i...</div>';
        try {
            const res = await fetch(`./sections/tasks.html?t=` + Date.now()); if(!res.ok) throw new Error("File kh√¥ng t·ªìn t·∫°i");
            sectionHost.innerHTML = await res.text(); document.getElementById('pageTitle').innerText = 'Qu·∫£n l√Ω b√†i t·∫≠p';
            await loadLearnersForTask(); await loadTasksFromDB();
            openTaskModal(); const select = document.getElementById('task-learner'); if(select) select.value = learnerId;
        } catch(e) { sectionHost.innerHTML = 'L·ªói: ' + e.message; }
    }
    window.initRankingPage = async function() {
        const topList = document.getElementById('top-students-list'); const warnList = document.getElementById('warning-students-list'); if(!topList) return;
        try {
            const res = await fetch('http://127.0.0.1:5002/api/rankings'); const data = await res.json();
            if(data.length === 0) { topList.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu.</p>'; return; }
            topList.innerHTML = ''; warnList.innerHTML = ''; let hasWarning = false;
            data.forEach((student, index) => {
                let medal = ''; let rankStyle = 'background:white; border:1px solid #e2e8f0; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;';
                if(index === 0) { medal = 'ü•á'; rankStyle += ' border-left: 5px solid #eab308; background: #fefce8;'; } else if(index === 1) { medal = 'ü•à'; rankStyle += ' border-left: 5px solid #94a3b8;'; } else if(index === 2) { medal = 'ü•â'; rankStyle += ' border-left: 5px solid #b45309;'; } else { medal = `<span style="font-weight:bold; color:#64748b; width:20px; text-align:center;">#${index + 1}</span>`; }
                topList.innerHTML += `<div style="${rankStyle}"><div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="openLearnerModal('${student.id}')"><div style="font-size:1.5rem;">${medal}</div><div><div style="font-weight:bold; color:#334155; text-decoration:underline;">${student.name}</div><div style="font-size:0.85rem; color:#64748b;">ƒê√£ h·ªçc: ${student.total_lessons} b√†i</div></div></div><div style="font-weight:bold; font-size:1.2rem; color:#2563eb;">${student.avg_score}</div></div>`;
                if(student.avg_score < 6.0) { hasWarning = true; warnList.innerHTML += `<div style="background:#fef2f2; border:1px solid #fee2e2; padding:15px; border-radius:12px; margin-bottom:10px;"><div style="font-weight:bold; color:#991b1b; cursor:pointer;" onclick="openLearnerModal('${student.id}')">${student.name}</div><div style="display:flex; justify-content:space-between; margin-top:5px;"><span style="font-size:0.9rem; color:#b91c1c;">ƒêi·ªÉm TB: <strong>${student.avg_score}</strong></span><button class="btn btn-sm btn-outline" style="padding:4px 10px; font-size:0.8rem; background:white;" onclick="goToAssignTask('${student.id}')">Giao b√†i</button></div></div>`; }
            });
            if(!hasWarning) { warnList.innerHTML = '<div class="alert-card" style="background:#f0fdf4; color:#166534; border:1px solid #dcfce7;">‚úÖ T·∫•t c·∫£ h·ªçc vi√™n ƒë·ªÅu ƒë·∫°t th√†nh t√≠ch t·ªët!</div>'; }
        } catch(e) { topList.innerHTML = 'L·ªói t·∫£i x·∫øp h·∫°ng.'; }
    }
    window.initResourcesPage = async function() {
        const tbody = document.getElementById('resource-table-body'); if(!tbody) return; tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr>';
        try { const res = await fetch('http://127.0.0.1:5002/api/resources'); const data = await res.json(); window.allResources = data; renderResources(data); } catch(e) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>'; }
    }
    window.renderResources = function(list) {
        const tbody = document.getElementById('resource-table-body'); if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#94a3b8;">Ch∆∞a c√≥ t√†i li·ªáu n√†o.</td></tr>'; return; }
        tbody.innerHTML = '';
        list.forEach(item => {
            let skillColor = '#64748b'; let skillBg = '#f1f5f9';
            if(item.skill_type === 'Speaking') { skillColor = '#d97706'; skillBg = '#fffbeb'; }
            if(item.skill_type === 'Listening') { skillColor = '#059669'; skillBg = '#d1fae5'; }
            if(item.skill_type === 'Vocabulary') { skillColor = '#7c3aed'; skillBg = '#ede9fe'; }
            tbody.innerHTML += `<tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding:15px;"><span style="background:${skillBg}; color:${skillColor}; padding:4px 10px; border-radius:20px; font-weight:bold; font-size:0.8rem;">${item.skill_type}</span></td><td style="padding:15px; font-weight:600; color:#334155;">${item.title}</td><td style="padding:15px; color:#64748b;">${item.description}</td><td style="padding:15px; text-align:right;"><a href="${item.link}" target="_blank" class="btn btn-sm btn-outline" style="background:#fff; color:#2563eb; border:1px solid #bfdbfe;"><i class="fa-solid fa-arrow-up-right-from-square"></i> M·ªü</a></td></tr>`;
        });
    }
    window.filterResources = function(skill) {
        if(!window.allResources) return;
        if(skill === 'All') renderResources(window.allResources); else renderResources(window.allResources.filter(r => r.skill_type === skill));
    }
    window.submitResource = async function() {
        const title = document.getElementById('res-title').value; const link = document.getElementById('res-link').value; const skill = document.getElementById('res-skill').value; const desc = document.getElementById('res-desc').value;
        if(!title || !link) { alert("Vui l√≤ng nh·∫≠p T√™n v√† Link!"); return; }
        try { const res = await fetch('http://127.0.0.1:5002/api/resources', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: title, link: link, skill_type: skill, description: desc }) }); if(res.ok) { alert("‚úÖ Th√™m t√†i li·ªáu th√†nh c√¥ng!"); closeResourceModal(); initResourcesPage(); } else { alert("‚ùå L·ªói khi th√™m"); } } catch(e) { alert("L·ªói: " + e.message); }
    }
    window.initTopicsPage = async function() { await loadLearnersForTopic(); await loadTopicsLibrary(); await loadAssignedTopicsHistory(); }
    async function loadLearnersForTopic() {
        const select = document.getElementById('topic-learner-select'); if(!select) return;
        try { const res = await fetch(window.LEARNERS_API_URL); const data = await res.json(); select.innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>'; data.forEach(l => { select.innerHTML += `<option value="${l.id}" data-name="${l.full_name}">${l.full_name}</option>`; }); } catch(e) {}
    }
    async function loadTopicsLibrary() {
        const list = document.getElementById('topics-library-list'); const select = document.getElementById('topic-select'); if(!list) return;
        try { const res = await fetch('http://127.0.0.1:5002/api/topics'); const data = await res.json(); list.innerHTML = ''; select.innerHTML = '<option value="">-- Ch·ªçn ch·ªß ƒë·ªÅ trong th∆∞ vi·ªán --</option>'; if(data.length === 0) { list.innerHTML = '<p>Th∆∞ vi·ªán tr·ªëng.</p>'; return; } data.forEach(t => { select.innerHTML += `<option value="${t.topic_name}">${t.topic_name}</option>`; list.innerHTML += `<div style="background:white; padding:15px; border:1px solid #e2e8f0; border-radius:12px;"><div style="font-weight:bold; color:#334155; margin-bottom:5px;">${t.topic_name}</div><div style="font-size:0.85rem; color:#64748b; margin-bottom:8px;"><span style="background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius:4px;">${t.level}</span></div><div style="font-size:0.9rem; color:#475569;">${t.description}</div></div>`; }); } catch(e) { list.innerHTML = 'L·ªói t·∫£i th∆∞ vi·ªán.'; }
    }
    async function loadAssignedTopicsHistory() {
        const tbody = document.getElementById('assigned-topics-body'); if(!tbody) return;
        try { const res = await fetch('http://127.0.0.1:5002/api/assigned-topics'); const data = await res.json(); tbody.innerHTML = ''; if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px; color:#94a3b8;">Ch∆∞a giao ch·ªß ƒë·ªÅ n√†o.</td></tr>'; return; } data.forEach(a => { tbody.innerHTML += `<tr style="border-bottom:1px solid #f1f5f9;"><td style="padding:10px; color:#64748b;">${a.date}</td><td style="padding:10px; font-weight:600;">${a.learner_name}</td><td style="padding:10px; color:#2563eb;">${a.topic_name}</td></tr>`; }); } catch(e) {}
    }
    window.assignTopicToLearner = async function() {
        const lSelect = document.getElementById('topic-learner-select'); const tSelect = document.getElementById('topic-select'); const lId = lSelect.value; const lName = lSelect.options[lSelect.selectedIndex].getAttribute('data-name'); const tName = tSelect.value;
        if(!lId || !tName) { alert("Vui l√≤ng ch·ªçn h·ªçc vi√™n v√† ch·ªß ƒë·ªÅ!"); return; }
        try { const res = await fetch('http://127.0.0.1:5002/api/assign-topic', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ learner_id: lId, learner_name: lName, topic_name: tName }) }); if(res.ok) { alert("‚úÖ Giao ch·ªß ƒë·ªÅ th√†nh c√¥ng!"); loadAssignedTopicsHistory(); } else { alert("‚ùå L·ªói khi giao"); } } catch(e) { alert("L·ªói: " + e.message); }
    }
    window.submitNewTopic = async function() {
        const name = document.getElementById('new-topic-name').value; const level = document.getElementById('new-topic-level').value; const desc = document.getElementById('new-topic-desc').value;
        if(!name) { alert("Nh·∫≠p t√™n ch·ªß ƒë·ªÅ!"); return; }
        try { const res = await fetch('http://127.0.0.1:5002/api/topics', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ topic_name: name, level: level, description: desc }) }); if(res.ok) { alert("‚úÖ T·∫°o ch·ªß ƒë·ªÅ th√†nh c√¥ng!"); closeCreateTopicModal(); loadTopicsLibrary(); } else { alert("‚ùå L·ªói khi t·∫°o"); } } catch(e) { alert("L·ªói: " + e.message); }
    }
    window.initSubmissionsPage = async function() {
        const tbody = document.getElementById('submissions-table-body'); if(!tbody) return; tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ƒêang t·∫£i...</td></tr>';
        try {
            const res = await fetch('http://127.0.0.1:5002/api/submissions'); const data = await res.json();
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">Ch∆∞a c√≥ b√†i n·ªôp n√†o.</td></tr>'; return; }
            tbody.innerHTML = '';
            data.forEach(sub => {
                let statusBadge = sub.status === 'Pending' ? `<span style="background:#fffbeb; color:#d97706; padding:4px 8px; border-radius:12px; font-weight:bold; font-size:0.8rem;">Ch∆∞a ch·∫•m</span>` : `<span style="background:#dcfce7; color:#16a34a; padding:4px 8px; border-radius:12px; font-weight:bold; font-size:0.8rem;">ƒê√£ ch·∫•m (${sub.score})</span>`;
                tbody.innerHTML += `<tr style="border-bottom: 1px solid #f1f5f9;"><td style="padding:15px; font-weight:600;">${sub.learner_name}</td><td style="padding:15px;">${sub.task_title}</td><td style="padding:15px; color:#64748b;">${sub.date}</td><td style="padding:15px;">${statusBadge}</td><td style="padding:15px; text-align:right;"><button class="btn btn-sm btn-outline" style="background:#fff; color:#2563eb; border:1px solid #bfdbfe;" onclick="openGradingModal('${sub.id}', '${sub.audio_link}', '${sub.score}', '${sub.feedback || ''}')"><i class="fa-solid fa-pen-to-square"></i> Ch·∫•m</button></td></tr>`;
            });
        } catch(e) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>'; }
    }
    window.submitGrade = async function() {
        const id = document.getElementById('current-submission-id').value; const score = document.getElementById('grade-score').value; const feedback = document.getElementById('grade-feedback').value;
        if(!score) { alert("Vui l√≤ng nh·∫≠p ƒëi·ªÉm s·ªë!"); return; }
        try { const res = await fetch(`http://127.0.0.1:5002/api/submissions/${id}/grade`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ score: score, feedback: feedback }) }); if(res.ok) { alert("‚úÖ Ch·∫•m ƒëi·ªÉm th√†nh c√¥ng!"); closeGradingModal(); initSubmissionsPage(); } else { alert("‚ùå L·ªói khi l∆∞u"); } } catch(e) { alert("L·ªói k·∫øt n·ªëi: " + e.message); }
    }
    window.initSettingsPage = async function() {
        try {
            const res = await fetch(`http://127.0.0.1:5002/api/settings/${window.CURRENT_MENTOR_ID}`); const data = await res.json();
            if(data.theme) document.getElementById('set-theme').value = data.theme;
            if(data.reminder_enabled) document.getElementById('set-remind-check').checked = true;
            if(data.reminder_time) document.getElementById('set-remind-time').value = data.reminder_time;
        } catch(e) { console.error("L·ªói t·∫£i c√†i ƒë·∫∑t"); }
    }
    window.saveSettings = async function() {
        const theme = document.getElementById('set-theme').value; const remind = document.getElementById('set-remind-check').checked; const time = document.getElementById('set-remind-time').value;
        try { await fetch('http://127.0.0.1:5002/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: window.CURRENT_MENTOR_ID, theme: theme, reminder_enabled: remind, reminder_time: time }) }); alert("‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t!"); applySettings(); } catch(e) { alert("L·ªói l∆∞u c√†i ƒë·∫∑t"); }
    }
    window.applySettings = async function() {
        try { const res = await fetch(`http://127.0.0.1:5002/api/settings/${window.CURRENT_MENTOR_ID}`); const data = await res.json(); if(data.theme === 'Dark') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); } catch(e) {}
    }
    async function loadMentorsFromAPI() {
        const listContainer = document.getElementById('api-mentor-list'); listContainer.innerHTML = '<p style="color:#666;">ƒêang c·∫≠p nh·∫≠t...</p>';
        try {
            const response = await fetch('http://127.0.0.1:5002/api/mentors'); const mentors = await response.json(); listContainer.innerHTML = '';
            if (mentors.length === 0) { listContainer.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu.</p>'; return; }
            mentors.forEach(mentor => {
                let skills = []; try { skills = (typeof mentor.skills === 'string') ? JSON.parse(mentor.skills) : mentor.skills; } catch(e) { skills = [mentor.skills]; } if (!Array.isArray(skills)) skills = [];
                const skillsHTML = skills.map(s => `<span class="mentor-skill-tag">${s}</span>`).join('');
                const statusColor = mentor.status === 'APPROVED' ? '#16a34a' : '#d97706'; const statusBg = mentor.status === 'APPROVED' ? '#dcfce7' : '#fffebf';
                listContainer.innerHTML += `<div class="mentor-item"><div style="display:flex; justify-content:space-between; margin-bottom:8px;"><div style="font-weight:bold;">${mentor.full_name}</div><small style="color:${statusColor}; background:${statusBg}; padding: 2px 8px; border-radius: 4px; font-weight:bold;">${mentor.status || 'PENDING'}</small></div><div style="margin-bottom:10px;">${skillsHTML}</div><p style="color:#64748b; font-size:0.9rem;">${mentor.bio || 'Ch∆∞a c√≥ gi·ªõi thi·ªáu'}</p><div style="font-size:0.8rem; color:#94a3b8;">ID: ${mentor.user_id}</div></div>`;
            });
        } catch (error) { listContainer.innerHTML = `<p style="color:red;">‚ùå L·ªói k·∫øt n·ªëi API.</p>`; }
    }
    async function registerMentorTest() {
        const name = document.getElementById('new-name').value; const skills = document.getElementById('new-skills').value; const bio = document.getElementById('new-bio').value;
        if (!name) { alert("Vui l√≤ng nh·∫≠p t√™n!"); return; }
        try {
            const response = await fetch('http://127.0.0.1:5002/api/mentors', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: "user_" + Math.floor(Math.random() * 99999), full_name: name, bio: bio || "Ch∆∞a c√≥ gi·ªõi thi·ªáu", skills: skills ? skills.split(',') : ["General"] }) });
            if (response.ok) { alert("‚úÖ C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!"); loadMentorsFromAPI(); } else { alert("‚ùå L·ªói l∆∞u d·ªØ li·ªáu"); }
        } catch (error) { alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message); }
    }
</script>
</body>
</html>