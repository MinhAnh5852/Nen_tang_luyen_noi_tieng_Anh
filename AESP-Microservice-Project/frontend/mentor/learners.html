<link rel="stylesheet" href="css/learners.css">
<div class="page-container">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1 class="page-title">H·ªçc vi√™n c·ªßa t√¥i</h1>
        <button class="btn btn-primary" onclick="init_learners()">
            <i class="fa-solid fa-sync" id="reload-icon"></i> T·∫£i l·∫°i danh s√°ch
        </button>
    </div>

    <div class="filter-bar">
        <div class="search-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="mentorSearchInput" onkeyup="filterLearnerTable()" placeholder="T√¨m h·ªçc vi√™n trong danh s√°ch..." class="form-input">
        </div>
        <div style="margin-left: auto; color: var(--text-light); font-size: 13px; font-weight: 600;">
            <i class="fa-solid fa-link"></i> <span id="learner-count">0</span> h·ªçc vi√™n ƒë√£ k·∫øt n·ªëi
        </div>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th style="width: 80px;">ID</th>
                    <th>Th√¥ng tin h·ªçc vi√™n</th>
                    <th>Tr√¨nh ƒë·ªô</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-right">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="learner-tbody">
                <tr>
                    <td colspan="5" style="text-align:center; padding: 40px; color: var(--text-light);">
                        <i class="fa-solid fa-spinner fa-spin"></i> ƒêang l·ªçc danh s√°ch h·ªçc vi√™n c·ªßa b·∫°n...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let learnersData = [];

    window.init_learners = async function() {
        const tableBody = document.getElementById('learner-tbody');
        const icon = document.getElementById('reload-icon');
        const countSpan = document.getElementById('learner-count');
        
        // 1. L·∫•y th√¥ng tin Mentor t·ª´ LocalStorage (Gi·ªëng ·∫£nh image_b1ed61.png)
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const mentorId = userInfo.id;
        const token = localStorage.getItem('token');
        
        if (!mentorId) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:red;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th√¥ng tin Mentor.</td></tr>`;
            return;
        }

        if (icon) icon.classList.add('fa-spin-custom');

        try {
            // 2. G·ªçi API l·∫•y danh s√°ch h·ªçc vi√™n d√†nh ri√™ng cho Mentor n√†y
            // Endpoint n√†y s·∫Ω tr·∫£ v·ªÅ nh·ªØng learner c√≥ learner_id n·∫±m trong b·∫£ng mentor_selections v·ªõi mentor_id n√†y
            const response = await fetch(`/api/users/mentors/my-learners/${mentorId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error("Kh√¥ng th·ªÉ truy c·∫≠p d·ªØ li·ªáu");

            learnersData = await response.json();
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
            countSpan.innerText = learnersData.length;
            
            renderLearnerTable(learnersData);
        } catch (error) {
            console.error(error);
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:red;">‚ö†Ô∏è L·ªói n·∫°p danh s√°ch h·ªçc vi√™n ƒë√£ k·∫øt n·ªëi.</td></tr>`;
        } finally {
            if (icon) setTimeout(() => icon.classList.remove('fa-spin-custom'), 500);
        }
    }

    function renderLearnerTable(data) {
        const tableBody = document.getElementById('learner-tbody');
        tableBody.innerHTML = '';

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">üì≠ B·∫°n ch∆∞a c√≥ h·ªçc vi√™n n√†o k·∫øt n·ªëi.</td></tr>';
            return;
        }

        data.forEach(user => {
            const email = user.email || "N/A";
            const status = (user.status || 'active').toLowerCase();
            const level = user.user_level || 'A1';
            
            tableBody.innerHTML += `
                <tr>
                    <td class="text-light">#${user.id ? user.id.substring(0, 6) : '---'}</td>
                    <td>
                        <div class="user-info">
                            <div class="avatar-circle avatar-blue" style="width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; background: var(--primary); color: white;">
                                ${email.substring(0,2).toUpperCase()}
                            </div>
                            <div class="user-text">
                                <h4 style="margin:0; font-size:14px; color: var(--text);">${user.username || email.split('@')[0]}</h4>
                                <span style="font-size:12px; color:var(--muted);">${email}</span>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge" style="background:#e0e7ff; color:#4361ee; font-weight:700; padding:4px 12px; border-radius:99px;">${level.toUpperCase()}</span></td>
                    <td>
                        <span class="badge ${status === 'active' ? 'badge-success' : ''}" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                            ${status === 'active' ? 'ƒêang h·ªçc' : 'T·∫°m d·ª´ng'}
                        </span>
                    </td>
                    <td class="text-right">
                        <button class="btn btn-primary btn-sm" onclick="window.parent.openModal('gradingModal')" style="padding: 5px 12px; font-size:11px;">
                            <i class="fa-solid fa-medal"></i> Ch·∫•m ƒëi·ªÉm
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    function filterLearnerTable() {
        const keyword = document.getElementById("mentorSearchInput").value.toLowerCase();
        const filtered = learnersData.filter(u => 
            u.email.toLowerCase().includes(keyword) || 
            (u.username && u.username.toLowerCase().includes(keyword))
        );
        renderLearnerTable(filtered);
    }

    // Kh·ªüi ch·∫°y
    init_learners();
</script>