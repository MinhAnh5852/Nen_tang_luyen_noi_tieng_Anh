<link rel="stylesheet" href="css/learners.css">
<div class="page-container">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1 class="page-title">Qu·∫£n l√Ω H·ªçc vi√™n</h1>
        <button class="btn btn-primary" onclick="init_learners()">
            <i class="fa-solid fa-sync" id="reload-icon"></i> T·∫£i l·∫°i d·ªØ li·ªáu
        </button>
    </div>

    <div class="filter-bar">
        <div class="search-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="mentorSearchInput" onkeyup="filterLearnerTable()" placeholder="T√¨m theo email ho·∫∑c t√™n..." class="form-input">
        </div>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th style="width: 80px;">ID</th>
                    <th>Th√¥ng tin h·ªçc vi√™n</th>
                    <th>Tr√¨nh ƒë·ªô</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-right">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="learner-tbody">
                <tr>
                    <td colspan="5" style="text-align:center; padding: 40px; color: var(--text-light);">
                        <i class="fa-solid fa-spinner fa-spin"></i> ƒêang n·∫°p d·ªØ li·ªáu t·ª´ h·ªá th·ªëng...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let learnersData = [];

    // G·∫Øn h√†m v√†o window ƒë·ªÉ mentor.html c√≥ th·ªÉ g·ªçi khi chuy·ªÉn tab
    window.init_learners = async function() {
        const tableBody = document.getElementById('learner-tbody');
        const icon = document.getElementById('reload-icon');
        const token = localStorage.getItem('token');
        
        if (icon) icon.classList.add('fa-spin-custom');

        try {
            // L·∫•y d·ªØ li·ªáu t·ª´ User Service qua API Gateway
            const response = await fetch('/api/users/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error("Unauthorized");

            const data = await response.json();
            // L·ªçc ch·ªâ l·∫•y nh·ªØng ng∆∞·ªùi d√πng c√≥ vai tr√≤ l√† learner
            learnersData = data.filter(u => (u.role || '').toLowerCase() === 'learner');
            renderLearnerTable(learnersData);
        } catch (error) {
            console.error(error);
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:red;">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i danh s√°ch (L·ªói Gateway ho·∫∑c Token)</td></tr>`;
        } finally {
            if (icon) setTimeout(() => icon.classList.remove('fa-spin-custom'), 500);
        }
    }

    function renderLearnerTable(data) {
        const tableBody = document.getElementById('learner-tbody');
        tableBody.innerHTML = '';

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">üì≠ Ch∆∞a c√≥ h·ªçc vi√™n n√†o.</td></tr>';
            return;
        }

        data.forEach(user => {
            const email = user.email || "N/A";
            const status = (user.status || 'active').toLowerCase();
            const level = user.user_level || 'A1';
            
            // S·ª≠ d·ª•ng c√°c class CSS t·ª´ admin/css/users.css
            tableBody.innerHTML += `
                <tr>
                    <td class="text-light">#${user.id ? user.id.substring(0, 6) : '---'}</td>
                    <td>
                        <div class="user-info">
                            <div class="avatar-circle avatar-blue" style="width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                                ${email.substring(0,2).toUpperCase()}
                            </div>
                            <div class="user-text">
                                <h4 style="margin:0; font-size:14px;">${user.username || email.split('@')[0]}</h4>
                                <span style="font-size:12px; color:var(--text-light);">${email}</span>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge badge-purple-border">${level.toUpperCase()}</span></td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${status === 'active' ? 'checked' : ''} disabled>
                            <span class="slider round"></span>
                        </label>
                    </td>
                    <td class="text-right">
                        <button class="btn btn-primary btn-sm" onclick="window.parent.openModal('gradingModal')" style="padding: 5px 12px; font-size:11px;">
                            <i class="fa-solid fa-medal"></i> Ch·∫•m ƒëi·ªÉm
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    function filterLearnerTable() {
        const keyword = document.getElementById("mentorSearchInput").value.toLowerCase();
        const filtered = learnersData.filter(u => 
            u.email.toLowerCase().includes(keyword) || 
            (u.username && u.username.toLowerCase().includes(keyword))
        );
        renderLearnerTable(filtered);
    }

    // Kh·ªüi ch·∫°y ngay khi n·∫°p file
    init_learners();
</script>