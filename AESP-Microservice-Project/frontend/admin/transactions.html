<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị Giao dịch - AESP Admin</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/users.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .status-SUCCESS { background: #dcfce7; color: #15803d; }
        .status-PENDING { background: #fef9c3; color: #854d0e; }
        .status-FAILED { background: #fee2e2; color: #b91c1c; }
        .btn-confirm { background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        .btn-confirm:hover { background: #059669; transform: scale(1.05); }
        .fa-sync.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title">Quản lý Lịch sử Giao dịch</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-dark" onclick="fetchTransactions()">
                    <i id="refresh-icon" class="fa-solid fa-sync"></i> Làm mới
                </button>
                <button class="btn btn-dark" onclick="exportToExcel()">
                    <i class="fa-solid fa-file-export"></i> Xuất Excel
                </button>
            </div>
        </div>

        <div class="filter-bar">
            <input type="text" id="search-inv" placeholder="Tìm theo ID người dùng hoặc Mã đơn..." class="form-input">
            <select class="form-select" id="filter-status">
                <option value="">Tất cả trạng thái</option>
                <option value="SUCCESS">Thành công</option>
                <option value="PENDING">Đang xử lý</option>
                <option value="FAILED">Thất bại</option>
            </select>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Mã đơn</th>
                        <th>Học viên (User ID)</th>
                        <th>Gói dịch vụ</th>
                        <th>Số tiền</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái</th>
                        <th class="text-right">Hành động</th>
                    </tr>
                </thead>
                <tbody id="transaction-tbody">
                    <tr>
                        <td colspan="7" style="text-align:center; padding: 30px;">
                            <i class="fa-solid fa-spinner fa-spin"></i> Đang kết nối Gateway...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    const API_URL = '/api/payments'; 
    let globalTransactions = [];

    document.addEventListener("DOMContentLoaded", fetchTransactions);

    // 1. Hàm Lấy dữ liệu (Và làm mới)
    async function fetchTransactions() {
        const icon = document.getElementById('refresh-icon');
        icon.classList.add('spinning'); // Hiệu ứng xoay khi bấm làm mới

        try {
            const response = await fetch(`${API_URL}/all`);
            if (!response.ok) throw new Error("Không thể lấy dữ liệu từ hệ thống");
            
            globalTransactions = await response.json();
            renderTable(globalTransactions);
        } catch (error) {
            console.error(error);
            document.getElementById('transaction-tbody').innerHTML = 
                `<tr><td colspan="7" style="color:red; text-align:center; padding: 20px;">
                    <i class="fa-solid fa-exclamation-triangle"></i> Lỗi: ${error.message}
                </td></tr>`;
        } finally {
            setTimeout(() => icon.classList.remove('spinning'), 500);
        }
    }

    // 2. Hàm Xuất Excel
    function exportToExcel() {
        if (globalTransactions.length === 0) {
            alert("Không có dữ liệu để xuất!");
            return;
        }

        // Chuyển đổi dữ liệu sang định dạng tiếng Việt cho Excel
        const dataForExcel = globalTransactions.map(t => ({
            "Mã Đơn": `#INV-${t.id}`,
            "User ID": t.user_id,
            "Gói Dịch Vụ": t.package_name,
            "Số Tiền": t.amount,
            "Phương Thức": t.method,
            "Ngày Tạo": t.created_at,
            "Trạng Thái": t.status === 'SUCCESS' ? 'Thành công' : (t.status === 'PENDING' ? 'Chờ duyệt' : 'Thất bại')
        }));

        const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "GiaoDich");

        // Tự động căn chỉnh độ rộng cột
        const wscols = [{wch:15}, {wch:25}, {wch:15}, {wch:15}, {wch:15}, {wch:20}, {wch:15}];
        worksheet['!cols'] = wscols;

        XLSX.writeFile(workbook, `AESP_GiaoDich_${new Date().getTime()}.xlsx`);
    }

    // 3. Hàm Duyệt đơn
    async function confirmTx(id) {
        if(!confirm(`Xác nhận đã nhận tiền cho đơn hàng #INV-${id}?`)) return;
        
        try {
            const response = await fetch(`${API_URL}/confirm/${id}`, { method: 'POST' });
            const result = await response.json();
            
            if(response.ok) {
                alert("Thành công: " + result.message);
                fetchTransactions(); 
            } else {
                alert("Lỗi: " + result.error);
            }
        } catch (error) {
            alert("Lỗi kết nối khi xác nhận giao dịch.");
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('transaction-tbody');
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Không có dữ liệu.</td></tr>';
            return;
        }
        data.forEach(item => {
            const statusLabel = item.status === 'SUCCESS' ? 'Thành công' : (item.status === 'PENDING' ? 'Chờ duyệt' : 'Thất bại');
            const row = `
                <tr>
                    <td style="font-weight: 600;">#INV-${item.id}</td>
                    <td>
                        <div class="user-info">
                            <div class="avatar-circle avatar-blue">${item.user_id.charAt(0).toUpperCase()}</div>
                            <div class="user-text">
                                <h4 style="font-size: 12px;">ID: ${item.user_id}</h4>
                                <span>PT: ${item.method}</span>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge badge-purple-border">${item.package_name}</span></td>
                    <td style="font-weight: 700;">${new Intl.NumberFormat('vi-VN').format(item.amount)}đ</td>
                    <td class="text-light">${item.created_at}</td>
                    <td><span class="status-badge status-${item.status}">${statusLabel}</span></td>
                    <td class="text-right">
                        ${item.status === 'PENDING' ? `<button class="btn-confirm" onclick="confirmTx(${item.id})">Duyệt</button>` : `<i class="fa-solid fa-check-double" style="color: #10b981;"></i>`}
                    </td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    function applyFilters() {
        const keyword = document.getElementById('search-inv').value.toLowerCase();
        const statusFilter = document.getElementById('filter-status').value;
        const filtered = globalTransactions.filter(t => {
            const matchKeyword = t.user_id.toLowerCase().includes(keyword) || `#inv-${t.id}`.includes(keyword);
            const matchStatus = statusFilter === "" || t.status === statusFilter;
            return matchKeyword && matchStatus;
        });
        renderTable(filtered);
    }
    document.getElementById('search-inv').addEventListener('input', applyFilters);
    document.getElementById('filter-status').addEventListener('change', applyFilters);
    </script>
</body>
</html>