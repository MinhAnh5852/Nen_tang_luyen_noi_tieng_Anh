<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Học viên - AESP</title>
    
    <link rel="stylesheet" href="/admin/css/main.css">
    <link rel="stylesheet" href="/admin/css/users.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 420px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .modal-footer { text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .fa-spin-custom { animation: fa-spin 0.8s infinite linear; }
        .password-hint { font-size: 11px; color: #666; margin-top: 4px; display: none; }
    </style>
</head>
<body>

    <div class="page-container">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 class="page-title">Quản lý Học viên (Learners)</h1>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="fa-solid fa-plus"></i> Thêm mới
            </button>
        </div>

        <div class="filter-bar">
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Tìm theo email hoặc tên..." class="form-input">
            </div>
            <button class="btn btn-dark" onclick="loadUsers()">
                <i class="fa-solid fa-rotate" id="reload-icon"></i> Tải lại
            </button>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>Thông tin học viên</th>
                        <th>Vai trò</th>
                        <th>Trạng thái</th>
                        <th class="text-right">Hành động</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    <tr><td colspan="5" style="text-align:center; padding: 40px;">Đang kết nối API Gateway...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0">Thêm tài khoản mới</h3>
            <form id="user-form">
                <input type="hidden" id="form-user-id">
                
                <div class="form-group">
                    <label>Họ và tên</label>
                    <input type="text" id="form-username" placeholder="Nhập tên người dùng" required>
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="form-email" placeholder="ví dụ: admin@test.com" required>
                </div>

                <div class="form-group">
                    <label>Mật khẩu</label>
                    <input type="password" id="form-password" placeholder="Nhập mật khẩu">
                    <span id="pass-hint" class="password-hint">* Để trống nếu không muốn thay đổi mật khẩu</span>
                </div>

                <div class="form-group">
                    <label>Vai trò (Role)</label>
                    <select id="form-role">
                        <option value="learner">LEARNER</option>
                        <option value="mentor">MENTOR</option>
                        <option value="admin">ADMIN</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal()" style="background:#6c757d; color:white; border:none; padding:10px 15px; border-radius:6px; cursor:pointer">Hủy</button>
                    <button type="submit" class="btn btn-primary" style="padding:10px 15px; border-radius:6px;">Lưu dữ liệu</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let usersData = [];

        document.addEventListener("DOMContentLoaded", loadUsers);

        async function loadUsers() {
            const tableBody = document.getElementById('user-table-body');
            const icon = document.getElementById('reload-icon');
            icon.classList.add('fa-spin-custom');

            try {
                const response = await fetch('/api/users/all');
                if (!response.ok) throw new Error("Không thể lấy dữ liệu");

                usersData = await response.json();
                renderTable(usersData);
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">❌ Lỗi kết nối API!</td></tr>`;
            } finally {
                setTimeout(() => icon.classList.remove('fa-spin-custom'), 500);
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = '';

            data.forEach(user => {
                const email = user.email || "N/A";
                const role = (user.role || 'learner').toLowerCase();
                const status = (user.status || 'active').toLowerCase();
                let roleClass = role === 'admin' ? 'badge-yellow-soft' : (role === 'mentor' ? 'badge-blue-soft' : 'badge-gray-border');

                tableBody.innerHTML += `
                    <tr>
                        <td class="text-light">#${user.id ? user.id.substring(0, 6) : '---'}</td>
                        <td>
                            <div class="user-info" style="display:flex; align-items:center; gap:12px;">
                                <div class="avatar-circle" style="width:35px; height:35px; border-radius:50%; background:#ff9800; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;">${email.substring(0,2).toUpperCase()}</div>
                                <div class="user-text">
                                    <h4 style="margin:0; font-size:14px;">${user.username || email.split('@')[0]}</h4>
                                    <span style="font-size:12px; color:gray;">${email}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge ${roleClass}">${role.toUpperCase()}</span></td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" ${status === 'active' ? 'checked' : ''} onchange="toggleStatus('${user.id}', this)">
                                <span class="slider round"></span>
                            </label>
                        </td>
                        <td class="text-right">
                            <button class="action-btn btn-edit" onclick='openEditModal(${JSON.stringify(user)})'><i class="fa-solid fa-pen"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteUser('${user.id}')" style="margin-left:10px; color:red;"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function openAddModal() {
            document.getElementById('modal-title').innerText = "Thêm tài khoản mới";
            document.getElementById('form-user-id').value = "";
            document.getElementById('user-form').reset();
            document.getElementById('form-password').required = true; // Bắt buộc khi thêm mới
            document.getElementById('pass-hint').style.display = "none";
            document.getElementById('userModal').style.display = 'flex';
        }

        function openEditModal(user) {
            document.getElementById('modal-title').innerText = "Chỉnh sửa tài khoản";
            document.getElementById('form-user-id').value = user.id;
            document.getElementById('form-username').value = user.username || "";
            document.getElementById('form-email').value = user.email;
            document.getElementById('form-role').value = user.role.toLowerCase();
            document.getElementById('form-password').value = "";
            document.getElementById('form-password').required = false; // Không bắt buộc khi sửa
            document.getElementById('pass-hint').style.display = "block";
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('userModal').style.display = 'none'; }

        document.getElementById('user-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-user-id').value;
            const password = document.getElementById('form-password').value;
            
            const data = {
                id: id,
                username: document.getElementById('form-username').value,
                email: document.getElementById('form-email').value,
                role: document.getElementById('form-role').value
            };
            
            if (password) data.password = password;

            const url = id ? '/api/users/auth/update-role' : '/api/users/auth/register';
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    closeModal();
                    loadUsers();
                } else {
                    const err = await res.json();
                    alert("Lỗi: " + (err.message || "Không thể lưu dữ liệu"));
                }
            } catch (err) {
                alert("Lỗi kết nối server!");
            }
        };

        async function deleteUser(id) {
            if (!confirm("Bạn có chắc chắn muốn xóa vĩnh viễn người dùng này?")) return;
            const res = await fetch(`/api/users/auth/delete/${id}`, { method: 'DELETE' });
            if (res.ok) loadUsers();
            else alert("Lỗi khi xóa!");
        }

        async function toggleStatus(id, checkbox) {
            const status = checkbox.checked ? 'active' : 'inactive';
            await fetch('/api/users/auth/update-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, status })
            });
        }

        function filterTable() {
            const keyword = document.getElementById("searchInput").value.toLowerCase();
            const filtered = usersData.filter(u => u.email.toLowerCase().includes(keyword) || (u.username && u.username.toLowerCase().includes(keyword)));
            renderTable(filtered);
        }
    </script>
</body>
</html>