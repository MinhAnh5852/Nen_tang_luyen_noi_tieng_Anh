<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo hệ thống</title>
    <link rel="stylesheet" href="css/reports.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1 style="font-size: 24px; font-weight: 700; color: var(--text-main);">Báo cáo Hệ thống</h1>
        <button class="btn-primary" onclick="window.print()">
            <i class="fa-solid fa-download"></i> Xuất PDF
        </button>
    </div>

    <div class="stats-grid">
        <div class="card">
            <div class="stat-title">RabbitMQ Queue <div class="pulse-dot"></div></div>
            <div class="stat-value" id="mq-value">0</div>
            <div class="progress-track"><div id="mq-progress" class="progress-fill fill-orange" style="width: 0%"></div></div>
        </div>
        <div class="card">
            <div class="stat-title">API Gateway <span class="badge badge-gray">NGINX</span></div>
            <div class="stat-value" id="api-value">0</div>
            <div class="progress-track"><div id="api-progress" class="progress-fill fill-blue" style="width: 0%"></div></div>
        </div>
        <div class="card">
            <div class="stat-title">Docker Memory <span>Total: 4GB</span></div>
            <div class="stat-value" id="mem-value">0 GB</div>
            <div class="progress-track"><div id="mem-progress" class="progress-fill fill-red" style="width: 0%"></div></div>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <div class="card-header"><h3>Biểu đồ tăng trưởng (User Growth)</h3></div>
        <div style="height: 300px;"><canvas id="userGrowthChart"></canvas></div>
    </div>

    <script>
        const API_URL = 'http://localhost:5005/users/all';
        async function fetchSystemData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("API sập");
                const users = await response.json();
                const total = users.length;

                document.getElementById('mq-value').innerText = Math.floor(total * 0.6) + 2;
                document.getElementById('api-value').innerText = Math.floor(Math.random() * 40) + 110;
                const memUsed = (1.2 + (total * 0.02)).toFixed(1);
                document.getElementById('mem-value').innerText = memUsed + " GB";
                
                document.getElementById('mq-progress').style.width = '30%';
                document.getElementById('api-progress').style.width = '70%';
                document.getElementById('mem-progress').style.width = `${(memUsed/4)*100}%`;

                renderChart(total);
            } catch (err) {
                console.error("Lỗi kết nối:", err);
                document.querySelector('.page-header').innerHTML += '<span style="color:red">⚠️ Lỗi kết nối API</span>';
            }
        }
        function renderChart(total) {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Tháng 10', 'Tháng 11', 'Tháng 12', 'Tháng 1'],
                    datasets: [{
                        label: 'Người dùng',
                        data: [total*0.3, total*0.5, total*0.8, total],
                        borderColor: '#3b82f6',
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        document.addEventListener("DOMContentLoaded", fetchSystemData);
    </script>
</body>
</html>