<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω Ph·∫£n h·ªìi - AESP</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/users.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .comment-text { white-space: normal; max-width: 300px; font-size: 13px; color: #1e293b; line-height: 1.5; }
        .rating-stars { color: #f59e0b; font-size: 12px; }
        .target-info { font-size: 12px; color: #3b82f6; font-weight: 600; background: #eff6ff; padding: 2px 8px; border-radius: 4px; }
        .avatar-orange { background-color: #f97316; color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; width: 35px; height: 35px; font-weight: bold; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-action { background: none; border: none; cursor: pointer; transition: transform 0.2s; padding: 5px; }
        .btn-action:hover { transform: scale(1.2); }
        
        /* HI·ªÜU ·ª®NG D√íNG ƒê√É ƒê·ªåC */
        .row-read {
            background-color: #f8fafc !important;
            opacity: 0.5;
            filter: grayscale(0.8);
            border-left: 3px solid #cbd5e1;
        }
        
        tr { transition: all 0.3s ease; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body style="background: #f8fafc; padding: 20px; font-family: 'Inter', sans-serif;">
    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title" style="font-size: 24px; color: #1e293b;">Ph·∫£n h·ªìi & ƒê√°nh gi√°</h1>
            <button class="btn-primary" onclick="loadFeedbacks()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                <i class="fa-solid fa-rotate"></i> L√†m m·ªõi d·ªØ li·ªáu
            </button>
        </div>

        <div class="table-card" style="background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr>
                        <th style="text-align: left; padding: 15px;">Ng∆∞·ªùi g·ª≠i</th>
                        <th style="text-align: left; padding: 15px;">ƒê·ªëi t∆∞·ª£ng</th>
                        <th style="text-align: left; padding: 15px;">N·ªôi dung</th>
                        <th style="text-align: left; padding: 15px;">ƒê√°nh gi√°</th>
                        <th style="text-align: left; padding: 15px;">Ng√†y g·ª≠i</th>
                        <th style="text-align: right; padding: 15px;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="feedback-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #64748b;">ƒêang k·∫øt n·ªëi API...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = '/api/users/feedbacks/all';

        async function loadFeedbacks() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("L·ªói HTTP: " + response.status);
                
                const data = await response.json();
                const tbody = document.getElementById('feedback-tbody');
                tbody.innerHTML = ''; 

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">üì≠ Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o trong h·ªá th·ªëng.</td></tr>';
                    return;
                }

                data.forEach(fb => {
                    const email = fb.email || "Guest";
                    const userName = email.split('@')[0];
                    const firstLetter = userName.charAt(0).toUpperCase();
                    
                    // Ki·ªÉm tra tr·∫°ng th√°i ƒë√£ ƒë·ªçc t·ª´ DB ƒë·ªÉ g√°n class CSS
                    const readClass = fb.is_read ? 'row-read' : '';
                    
                    let starsHTML = '';
                    const score = parseInt(fb.rating) || 0;
                    for (let i = 1; i <= 5; i++) {
                        starsHTML += i <= score ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>';
                    }

                    const row = `
                        <tr id="fb-row-${fb.id}" class="${readClass}">
                            <td style="padding: 15px;">
                                <div class="user-info">
                                    <div class="avatar-orange">${firstLetter}</div>
                                    <div class="user-text">
                                        <h4 style="text-transform: capitalize; margin:0; font-size:14px;">${userName}</h4>
                                        <span style="font-size:12px; color:#64748b;">${email}</span>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 15px;"><span class="target-info">${fb.target || 'H·ªá th·ªëng'}</span></td>
                            <td style="padding: 15px;"><p class="comment-text">${fb.content || '...'}</p></td>
                            <td style="padding: 15px;"><div class="rating-stars">${starsHTML}</div></td>
                            <td style="padding: 15px; color: #64748b; font-size: 13px;">${fb.date}</td>
                            <td style="padding: 15px; text-align: right;">
                                <button class="btn-action" onclick="markAsRead(${fb.id})" style="color: #10b981;" title="ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc">
                                    <i class="fa-solid fa-check-double"></i>
                                </button>
                                
                                <button class="btn-action" onclick="replyUser('${email}')" style="color: #3b82f6; margin: 0 10px;" title="G·ª≠i ph·∫£n h·ªìi tr·∫£ l·ªùi">
                                    <i class="fa-solid fa-reply"></i>
                                </button>

                                <button class="btn-action" onclick="deleteFeedback(${fb.id})" style="color: #ef4444;" title="X√≥a vƒ©nh vi·ªÖn">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (error) {
                console.error("L·ªói:", error);
                document.getElementById('feedback-tbody').innerHTML = 
                    `<tr><td colspan="6" style="text-align: center; padding: 30px; color: #ef4444;">‚ö†Ô∏è L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. H√£y ki·ªÉm tra Backend.</td></tr>`;
            }
        }

        // Ch·ª©c nƒÉng: ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc v√† L∆ØU V√ÄO DATABASE
        async function markAsRead(id) {
            try {
                const response = await fetch(`/api/users/feedbacks/${id}/read`, { method: 'PUT' });
                if (response.ok) {
                    const row = document.getElementById(`fb-row-${id}`);
                    if (row) {
                        row.classList.add('row-read'); // L√†m t·ªëi d√≤ng ngay l·∫≠p t·ª©c
                    }
                    // C·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng th√¥ng b√°o ·ªü qu·∫£ chu√¥ng (Index)
                    if (window.parent && typeof window.parent.updateFeedbackCount === 'function') {
                        window.parent.updateFeedbackCount();
                    }
                } else {
                    alert("L·ªói server khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë·ªçc.");
                }
            } catch (err) {
                console.error("L·ªói k·∫øt n·ªëi API Read:", err);
            }
        }

        // X√≥a kh·ªèi Database
        async function deleteFeedback(id) {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph·∫£n h·ªìi n√†y vƒ©nh vi·ªÖn?")) {
                try {
                    const response = await fetch(`/api/users/feedbacks/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        const row = document.getElementById(`fb-row-${id}`);
                        if (row) {
                            row.style.opacity = '0';
                            row.style.transform = 'scale(0.9)';
                            setTimeout(() => {
                                row.remove();
                                if (window.parent && typeof window.parent.updateFeedbackCount === 'function') {
                                    window.parent.updateFeedbackCount();
                                }
                            }, 300);
                        }
                    } else {
                        alert("L·ªói: Kh√¥ng th·ªÉ x√≥a ph·∫£n h·ªìi tr√™n server.");
                    }
                } catch (err) {
                    alert("L·ªói k·∫øt n·ªëi khi x√≥a.");
                }
            }
        }

        // G·ª≠i tin nh·∫Øn tr·∫£ l·ªùi
        async function replyUser(email) {
            const replyMsg = prompt(`Nh·∫≠p n·ªôi dung ph·∫£n h·ªìi g·ª≠i ƒë·∫øn ${email}:`);
            if (replyMsg && replyMsg.trim() !== "") {
                try {
                    const response = await fetch('/api/users/feedbacks/reply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, message: replyMsg })
                    });
                    if (response.ok) {
                        alert("ƒê√£ g·ª≠i th√†nh c√¥ng t·ªõi " + email);
                    } else {
                        alert("L·ªói khi g·ª≠i ph·∫£n h·ªìi.");
                    }
                } catch (err) {
                    alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi API ph·∫£n h·ªìi.");
                }
            }
        }

        document.addEventListener('DOMContentLoaded', loadFeedbacks);
    </script>
</body>
</html>