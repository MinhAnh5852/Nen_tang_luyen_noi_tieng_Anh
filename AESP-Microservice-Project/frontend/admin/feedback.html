<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/users.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .comment-text { white-space: normal; max-width: 300px; font-size: 13px; color: var(--text-main); }
        .rating-stars { color: #f59e0b; font-size: 12px; }
        .target-info { font-size: 12px; color: var(--primary); font-weight: 600; }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title">Phản hồi & Đánh giá</h1>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Người gửi</th>
                        <th>Đối tượng đánh giá</th>
                        <th>Nội dung phản hồi</th>
                        <th>Mức độ hài lòng</th>
                        <th>Ngày gửi</th>
                        <th class="text-right">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="feedback-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">Đang tải phản hồi...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Cấu hình URL API
        const API_URL = 'http://localhost:5005/users/feedbacks/all';

        async function loadFeedbacks() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Không thể kết nối API");
                
                const data = await response.json();
                const tbody = document.getElementById('feedback-tbody');
                tbody.innerHTML = ''; // Xóa dòng thông báo đang tải

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Chưa có phản hồi nào.</td></tr>';
                    return;
                }

                data.forEach(fb => {
                    const userName = fb.email.split('@')[0];
                    const firstLetter = userName.charAt(0).toUpperCase();
                    
                    // Xử lý hiển thị sao dựa trên số rating (1-5)
                    let starsHTML = '';
                    for (let i = 0; i < 5; i++) {
                        starsHTML += i < fb.rating ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>';
                    }

                    const row = `
                        <tr>
                            <td>
                                <div class="user-info">
                                    <div class="avatar-circle avatar-orange">${firstLetter}</div>
                                    <div class="user-text">
                                        <h4 style="text-transform: capitalize;">${userName}</h4>
                                        <span>${fb.email}</span>
                                    </div>
                                </div>
                            </td>
                            <td><span class="target-info">${fb.target}</span></td>
                            <td><p class="comment-text">${fb.content}</p></td>
                            <td>
                                <div class="rating-stars">
                                    ${starsHTML}
                                </div>
                            </td>
                            <td class="text-light">${fb.date}</td>
                            <td class="text-right">
                                <button class="action-btn" title="Đánh dấu đã đọc"><i class="fa-solid fa-check-double"></i></button>
                                <button class="action-btn btn-delete" title="Xóa"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (error) {
                console.error("Lỗi:", error);
                document.getElementById('feedback-tbody').innerHTML = 
                    `<tr><td colspan="6" style="text-align: center; color: red;">Lỗi tải dữ liệu: ${error.message}</td></tr>`;
            }
        }

        // Tự động chạy khi trang load xong
        document.addEventListener('DOMContentLoaded', loadFeedbacks);
    </script>
</body>
</html>